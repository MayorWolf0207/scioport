<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ScioPort – Admin</title>
  <style>
    :root{
      --bg:#eff4fa;
      --panel:#0f172a;
      --panel2:#172554;
      --text:#e2e8f0;
      --fg:#0f172a;
      --muted:#475569;
      --border:#dbe4ef;
      --accent:#2bbcff;
      --accent2:#3bd4b0;
      --ok:#16a34a;
      --warn:#ca8a04;
      --danger:#dc2626;
      --r:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 400px at 15% -10%, rgba(43,188,255,.22), transparent 55%),
        radial-gradient(700px 380px at 85% 0, rgba(59,212,176,.18), transparent 60%),
        linear-gradient(180deg,#eaf1f8,#f7fbff);
      color:var(--fg);
    }
    body[data-theme="dark"]{
      background:
        radial-gradient(900px 420px at 10% -10%, rgba(34,211,238,.15), transparent 55%),
        radial-gradient(780px 420px at 90% 0, rgba(59,130,246,.14), transparent 60%),
        linear-gradient(180deg,#020617,#0b1220);
      color:#e2e8f0;
    }
    .app{
      min-height:100vh;
      display:grid;
      grid-template-columns:280px 1fr;
      gap:16px;
      padding:16px;
    }
    .app.sidebar-collapsed{
      grid-template-columns:1fr;
    }
    .app.sidebar-collapsed .sidebar{
      display:none;
    }
    @media (max-width:980px){
      .app{grid-template-columns:1fr}
    }
    .sidebar{
      background:
        radial-gradient(500px 300px at 10% 0, rgba(43,188,255,.22), transparent 65%),
        linear-gradient(180deg, var(--panel2), var(--panel));
      border-radius:18px;
      color:var(--text);
      padding:14px;
      border:1px solid rgba(255,255,255,.15);
      box-shadow:0 16px 40px rgba(15,23,42,.3);
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .brand{
      border:1px solid rgba(255,255,255,.18);
      border-radius:16px;
      padding:10px 12px;
      background:rgba(255,255,255,.05);
    }
    .brand h1{margin:0;font-size:15px}
    .brand p{margin:4px 0 0 0;font-size:12px;opacity:.85}
    .nav{display:flex;flex-direction:column;gap:8px}
    .nav button{
      border:1px solid rgba(255,255,255,.16);
      color:var(--text);
      background:rgba(255,255,255,.04);
      text-align:left;
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-size:13px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .nav button.active{
      background:linear-gradient(135deg, rgba(43,188,255,.35), rgba(59,212,176,.22));
      border-color:rgba(43,188,255,.65);
    }
    .pill{
      font-size:11px;
      border:1px solid rgba(255,255,255,.2);
      border-radius:999px;
      padding:2px 7px;
    }
    .sidebar .actions{
      margin-top:auto;
      display:grid;
      gap:8px;
    }
    .btn{
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px 10px;
      background:#fff;
      color:var(--fg);
      cursor:pointer;
      font-size:13px;
    }
    .btn.primary{
      background:linear-gradient(135deg, rgba(43,188,255,.2), rgba(59,212,176,.16));
      border-color:rgba(43,188,255,.4);
    }
    .btn.warn{border-color:rgba(202,138,4,.35); background:rgba(202,138,4,.1)}
    .btn.danger{border-color:rgba(220,38,38,.35); background:rgba(220,38,38,.1)}
    .main{
      background:#fff;
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 12px 32px rgba(15,23,42,.12);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:calc(100vh - 32px);
    }
    .topbar{
      border-bottom:1px solid var(--border);
      padding:12px 14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      position:sticky;
      top:0;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      z-index:10;
    }
    .topbar h2{margin:0;font-size:15px}
    .topbar p{margin:3px 0 0 0;font-size:12px;color:var(--muted)}
    #content{padding:14px}
    .card{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      margin-bottom:12px;
      overflow:hidden;
    }
    .card h3{
      margin:0;
      font-size:13px;
      padding:11px 12px;
      background:linear-gradient(180deg, rgba(43,188,255,.08), rgba(255,255,255,.9));
      border-bottom:1px solid var(--border);
    }
    .cardBody{padding:12px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    .col12{grid-column:span 12}
    .col6{grid-column:span 6}
    .col4{grid-column:span 4}
    .kpi{
      border:1px solid var(--border);
      border-radius:12px;
      background:#f8fbff;
      padding:10px;
    }
    .kpi b{font-size:20px}
    .kpi span{display:block;font-size:12px;color:var(--muted);margin-top:4px}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .title{font-size:13px;font-weight:600}
    .meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:5px}
    .badge{
      font-size:11px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:2px 7px;
      background:#f8fafc;
    }
    .badge.ok{background:rgba(22,163,74,.12);border-color:rgba(22,163,74,.35);color:#166534}
    .badge.warn{background:rgba(202,138,4,.14);border-color:rgba(202,138,4,.35);color:#854d0e}
    .badge.unread{background:rgba(43,188,255,.15);border-color:rgba(43,188,255,.35);color:#075985}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input, textarea, select{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:9px 10px;
      font-size:13px;
      color:var(--fg);
      background:#fff;
    }
    textarea{min-height:84px;resize:vertical}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:5px}
    .empty{
      border:1px dashed var(--border);
      border-radius:12px;
      padding:12px;
      font-size:13px;
      color:var(--muted);
      background:#fbfdff;
    }
    .hint{font-size:12px;color:var(--muted)}
    .split{
      display:grid;
      grid-template-columns:300px 1fr;
      gap:12px;
    }
    @media (max-width:980px){
      .split{grid-template-columns:1fr}
      .col6,.col4{grid-column:span 12}
    }
    .classBtn{
      width:100%;
      text-align:left;
      border:1px solid var(--border);
      border-radius:12px;
      padding:9px;
      background:#fff;
      cursor:pointer;
      margin-bottom:8px;
    }
    .classBtn.active{
      border-color:rgba(43,188,255,.45);
      background:rgba(43,188,255,.1);
    }
    .composeWrap{
      background:#f6f8fb;
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
    }
    .composeGrid{
      display:grid;
      grid-template-columns:repeat(12,minmax(0,1fr));
      gap:12px 14px;
    }
    .composeCol12{grid-column:span 12}
    .composeCol6{grid-column:span 6}
    .composeDivider{
      border:0;
      border-top:1px solid var(--border);
      margin:14px 0;
    }
    .composeHint{
      font-size:12px;
      color:var(--muted);
      margin:6px 0 0;
    }
    .composeSub{
      margin:0 0 8px;
      font-size:13px;
      color:var(--muted);
      font-weight:600;
    }
    .composeActions{
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }
    .hidden{display:none!important}
    .composeWrap input,
    .composeWrap textarea,
    .composeWrap select{
      background:#fff;
    }
    .composeCheckList{
      display:grid;
      gap:6px;
      max-height:180px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px;
      background:#fff;
    }
    .composeFilterInput{
      margin-bottom:8px;
    }
    .composeCheckEmpty.filterEmpty{
      margin-top:8px;
    }
    .composeCheckItem{
      display:flex;
      align-items:flex-start;
      gap:8px;
      margin:0;
      font-size:12px;
      color:var(--fg);
    }
    .composeCheckItem input{
      width:auto;
      margin-top:2px;
      flex-shrink:0;
    }
    .composeCheckEmpty{
      border:1px dashed var(--border);
      border-radius:10px;
      padding:8px;
      color:var(--muted);
      font-size:12px;
      background:#fbfdff;
    }
    @media (max-width:980px){
      .composeCol6{grid-column:span 12}
    }
    .toastWrap{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:90;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .toast{
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:0 16px 35px rgba(15,23,42,.16);
      padding:10px 12px;
      font-size:13px;
      min-width:260px;
    }
    .toast small{display:block;color:var(--muted);margin-top:3px}
    .dashWrap{
      border-radius:16px;
      border:1px solid var(--border);
      background:#f8fbff;
      overflow:hidden;
    }
    .dashHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(43,188,255,.12), rgba(255,255,255,.95));
    }
    .dashHeadTitle{
      display:inline-block;
      margin:0;
      font-size:28px;
      line-height:1;
    }
    .dashHeadMeta{
      margin-left:10px;
      color:var(--muted);
      font-size:13px;
      font-weight:600;
    }
    .dashWeekChip{
      border:1px solid var(--border);
      border-radius:999px;
      padding:7px 12px;
      background:#eef4f8;
      font-size:12px;
      white-space:nowrap;
    }
    .dashBody{
      padding:14px;
    }
    .dashMetricGrid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:12px;
    }
    .dashMetric{
      border:1px solid #d3dbe5;
      border-radius:22px;
      background:#fff;
      padding:14px 16px;
    }
    .dashMetricValue{
      font-size:36px;
      line-height:1.05;
      margin:0;
      letter-spacing:-0.02em;
      font-weight:600;
      color:#1e293b;
    }
    .dashMetricLabel{
      margin-top:8px;
      font-size:13px;
      color:#475569;
    }
    .dashSplit{
      display:grid;
      grid-template-columns:minmax(0,1fr) minmax(0,1fr);
      gap:14px;
    }
    .dashSectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
      gap:8px;
    }
    .dashSectionTitle{
      margin:0;
      font-size:20px;
      line-height:1;
      color:#c7d4e9;
      text-shadow:0 1px 0 rgba(255,255,255,.18);
    }
    .dashGhostBtn{
      border:1px solid var(--border);
      border-radius:14px;
      background:#fff;
      padding:7px 12px;
      font-size:14px;
      cursor:pointer;
      color:var(--fg);
    }
    .dashNotifList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .dashNotifItem{
      border:1px solid #d3dbe5;
      border-radius:20px;
      background:#fff;
      padding:13px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .dashNotifTitle{
      margin:0;
      font-size:24px;
      line-height:1.12;
      font-weight:500;
      color:#1f2937;
    }
    .dashChips{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .dashChip{
      border:1px solid #c9d2dd;
      border-radius:999px;
      padding:4px 11px;
      font-size:12px;
      color:#334155;
      background:#f4f7fb;
      white-space:nowrap;
    }
    .dashState{
      border:1px solid #e5c68a;
      color:#a16207;
      background:#fff8e8;
      border-radius:999px;
      padding:4px 11px;
      font-size:12px;
      white-space:nowrap;
    }
    .dashState.read{
      border-color:#bbf7d0;
      color:#166534;
      background:#ecfdf3;
    }
    .dashOpenBtn{
      border:1px solid #d1d9e4;
      border-radius:14px;
      padding:7px 12px;
      background:#fff;
      font-size:14px;
      cursor:pointer;
      color:#1f2937;
    }
    .dashActionList{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .dashActionItem{
      border:1px solid #d3dbe5;
      border-radius:20px;
      background:#fff;
      padding:14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .dashActionTitle{
      margin:0;
      font-size:23px;
      line-height:1.1;
      color:#1f2937;
    }
    .dashActionBtn{
      border:1px solid #8fd3f7;
      border-radius:20px;
      padding:8px 16px;
      background:#dff3ff;
      color:#0f172a;
      font-size:14px;
      cursor:pointer;
      white-space:nowrap;
    }
    .dashActionBtn.neutral{
      border-color:#d1d9e4;
      background:#f8fafc;
    }
    .dashShortcut{
      margin-top:12px;
      border-top:1px solid var(--border);
      padding-top:12px;
      color:#64748b;
      font-size:14px;
    }
    .dashKey{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:22px;
      height:22px;
      padding:0 8px;
      border:1px solid #cbd5e1;
      border-radius:10px;
      background:#f8fafc;
      color:#334155;
      font-size:12px;
      margin:0 3px;
    }
    .notifStack{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .notifIntro{
      border:1px solid var(--border);
      border-radius:22px;
      background:#fff;
      padding:14px 16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .notifIntroTitle{
      margin:0;
      font-size:30px;
      line-height:1.1;
      color:#0f172a;
    }
    .notifIntroSub{
      margin:6px 0 0;
      color:#475569;
      font-size:16px;
    }
    .notifIntroActions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .notifShortcut{
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:#475569;
      font-size:15px;
      white-space:nowrap;
    }
    .notifPanel{
      border:1px solid var(--border);
      border-radius:22px;
      overflow:hidden;
      background:#f8fbff;
    }
    .notifPanelHead{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(43,188,255,.12), rgba(255,255,255,.95));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .notifPanelTitle{
      margin:0;
      font-size:31px;
      line-height:1.08;
      color:#0f172a;
    }
    .notifPanelHint{
      margin-left:8px;
      font-size:15px;
      color:#475569;
      font-weight:500;
    }
    .notifPanelControls{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-left:auto;
    }
    .notifSearch{
      width:300px;
      max-width:100%;
      border-radius:16px;
    }
    .notifList{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .notifItem{
      border:1px solid #d3dbe5;
      border-radius:20px;
      background:#fff;
      padding:13px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .notifItemTitle{
      margin:0;
      font-size:31px;
      line-height:1.09;
      color:#1f2937;
      font-weight:500;
    }
    .notifEmpty{
      margin:0 12px 12px;
    }
    @media (max-width:1200px){
      .dashMetricGrid{grid-template-columns:repeat(2,minmax(0,1fr))}
      .dashSplit{grid-template-columns:1fr}
    }
    @media (max-width:760px){
      .dashMetricGrid{grid-template-columns:1fr}
      .dashHead{flex-direction:column;align-items:flex-start}
      .dashWeekChip{white-space:normal}
      .dashActionItem,
      .dashNotifItem{flex-direction:column}
      .notifIntro,
      .notifItem{flex-direction:column}
      .notifPanelControls{margin-left:0}
      .notifSearch{width:100%}
    }
    body[data-theme="dark"] .main{
      background:#0b1220;
      border-color:#334155;
      box-shadow:0 18px 40px rgba(2,6,23,.65);
    }
    body[data-theme="dark"] .topbar{
      border-bottom-color:#334155;
      background:rgba(11,18,32,.9);
    }
    body[data-theme="dark"] .topbar p,
    body[data-theme="dark"] label,
    body[data-theme="dark"] .hint,
    body[data-theme="dark"] .composeHint,
    body[data-theme="dark"] .composeSub,
    body[data-theme="dark"] .empty,
    body[data-theme="dark"] .composeCheckEmpty,
    body[data-theme="dark"] .toast small{
      color:#94a3b8;
    }
    body[data-theme="dark"] .btn{
      background:#0f172a;
      color:#e2e8f0;
      border-color:#334155;
    }
    body[data-theme="dark"] .btn.primary{
      background:linear-gradient(135deg, rgba(37,99,235,.32), rgba(14,165,233,.24));
      border-color:rgba(56,189,248,.42);
    }
    body[data-theme="dark"] .card{
      background:#0f172a;
      border-color:#334155;
    }
    body[data-theme="dark"] .card h3{
      background:linear-gradient(180deg, rgba(37,99,235,.18), rgba(15,23,42,.9));
      border-bottom-color:#334155;
    }
    body[data-theme="dark"] .kpi{
      background:#111a2b;
      border-color:#334155;
    }
    body[data-theme="dark"] .item{
      background:#0d1628;
      border-color:#334155;
    }
    body[data-theme="dark"] .badge{
      background:#111a2b;
      border-color:#334155;
      color:#cbd5e1;
    }
    body[data-theme="dark"] .composeWrap{
      background:#0b1324;
      border-color:#334155;
    }
    body[data-theme="dark"] .composeWrap input,
    body[data-theme="dark"] .composeWrap textarea,
    body[data-theme="dark"] .composeWrap select,
    body[data-theme="dark"] input,
    body[data-theme="dark"] textarea,
    body[data-theme="dark"] select{
      background:#0f172a;
      border-color:#334155;
      color:#e2e8f0;
    }
    body[data-theme="dark"] input::placeholder,
    body[data-theme="dark"] textarea::placeholder{
      color:#94a3b8;
    }
    body[data-theme="dark"] .composeCheckList{
      background:#0f172a;
      border-color:#334155;
    }
    body[data-theme="dark"] .composeCheckEmpty{
      background:#0d1628;
      border-color:#334155;
    }
    body[data-theme="dark"] .classBtn{
      background:#0f172a;
      border-color:#334155;
      color:#e2e8f0;
    }
    body[data-theme="dark"] .toast{
      background:#0f172a;
      border-color:#334155;
      color:#e2e8f0;
      box-shadow:0 18px 36px rgba(2,6,23,.65);
    }
    body[data-theme="dark"] .dashWrap{
      background:#0b1324;
      border-color:#334155;
    }
    body[data-theme="dark"] .dashHead{
      background:linear-gradient(180deg, rgba(30,64,175,.3), rgba(11,19,36,.92));
      border-bottom-color:#334155;
    }
    body[data-theme="dark"] .dashHeadMeta{
      color:#94a3b8;
    }
    body[data-theme="dark"] .dashWeekChip{
      background:#0f172a;
      border-color:#334155;
      color:#cbd5e1;
    }
    body[data-theme="dark"] .dashMetric,
    body[data-theme="dark"] .dashNotifItem,
    body[data-theme="dark"] .dashActionItem{
      background:#0f172a;
      border-color:#334155;
    }
    body[data-theme="dark"] .dashMetricValue,
    body[data-theme="dark"] .dashNotifTitle,
    body[data-theme="dark"] .dashActionTitle{
      color:#e2e8f0;
    }
    body[data-theme="dark"] .dashMetricLabel,
    body[data-theme="dark"] .dashShortcut{
      color:#94a3b8;
    }
    body[data-theme="dark"] .dashChip{
      border-color:#334155;
      background:#111a2b;
      color:#cbd5e1;
    }
    body[data-theme="dark"] .dashOpenBtn,
    body[data-theme="dark"] .dashGhostBtn{
      border-color:#334155;
      background:#0f172a;
      color:#e2e8f0;
    }
    body[data-theme="dark"] .dashActionBtn{
      border-color:#0ea5e9;
      background:#0c4a6e;
      color:#e0f2fe;
    }
    body[data-theme="dark"] .dashActionBtn.neutral{
      border-color:#334155;
      background:#111a2b;
      color:#e2e8f0;
    }
    body[data-theme="dark"] .dashKey{
      border-color:#334155;
      background:#111a2b;
      color:#cbd5e1;
    }
    body[data-theme="dark"] .notifIntro{
      background:#0f172a;
      border-color:#334155;
    }
    body[data-theme="dark"] .notifIntroTitle,
    body[data-theme="dark"] .notifPanelTitle,
    body[data-theme="dark"] .notifItemTitle{
      color:#e2e8f0;
    }
    body[data-theme="dark"] .notifIntroSub,
    body[data-theme="dark"] .notifShortcut,
    body[data-theme="dark"] .notifPanelHint{
      color:#94a3b8;
    }
    body[data-theme="dark"] .notifPanel{
      background:#0b1324;
      border-color:#334155;
    }
    body[data-theme="dark"] .notifPanelHead{
      border-bottom-color:#334155;
      background:linear-gradient(180deg, rgba(30,64,175,.3), rgba(11,19,36,.92));
    }
    body[data-theme="dark"] .notifItem{
      background:#0f172a;
      border-color:#334155;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <h1>ScioPort – Admin</h1>
        <p>Šablony a portfolia</p>
      </div>
      <div class="nav" id="nav">
        <button class="active" data-view="dashboard" title="Dashboard" aria-label="Dashboard"><span>🏠</span><span class="pill" id="pillDay">..</span></button>
        <button data-view="newTemplate" title="Nová šablona" aria-label="Nová šablona"><span>📝</span><span class="pill">Form</span></button>
        <button data-view="myTemplates" title="Moje šablony" aria-label="Moje šablony"><span>🗂️</span><span class="pill" id="pillTemplates">0</span></button>
        <button data-view="classes" title="Třídy" aria-label="Třídy"><span>👥</span><span class="pill" id="pillClasses">0</span></button>
        <button data-view="studentOverview" title="Přehled dítěte" aria-label="Přehled dítěte"><span>🔎</span><span class="pill">Search</span></button>
        <button data-view="notifications" title="Notifikace" aria-label="Notifikace"><span>🔔</span><span class="pill" id="pillUnread">0</span></button>
      </div>
      <div class="actions">
        <button class="btn warn" id="btnSimulate">🧪 TEST: simulovat vyplnění</button>
        <button class="btn danger" id="btnReset">🗑️ Reset dat</button>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <h2 id="viewTitle">Dashboard</h2>
          <p id="viewSub">Rychlý přehled šablon, tříd a vyplnění.</p>
        </div>
        <div class="row">
          <button class="btn" id="btnHome" type="button">🏠 Domů</button>
          <button class="btn" id="btnTheme" type="button" aria-pressed="false">🌙 Tmavý režim</button>
          <button class="btn" id="btnGoNotifs">🔔 Notifikace</button>
          <button class="btn primary" id="btnGoNew">➕ Nová šablona</button>
        </div>
      </div>
      <section id="content"></section>
    </main>
  </div>

  <div class="toastWrap" id="toastWrap"></div>

  <script>
  const $ = (selector, root) => (root || document).querySelector(selector);

  function esc(value) {
    return String(value == null ? "" : value)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;");
  }

  function toast(message, meta) {
    const wrap = $("#toastWrap");
    if (!wrap) {
      return;
    }
    const el = document.createElement("div");
    el.className = "toast";
    const title = document.createElement("div");
    title.textContent = message || "";
    el.appendChild(title);
    if (meta) {
      const small = document.createElement("small");
      small.textContent = meta;
      el.appendChild(small);
    }
    wrap.appendChild(el);
    window.setTimeout(function () {
      if (el.parentNode) {
        el.parentNode.removeChild(el);
      }
    }, 3600);
  }

  const firebaseConfig = {
    apiKey: "AIzaSyBYQPQwKYJLxcdjHHMv8w1KbLIIX-HKaQA",
    authDomain: "scioport.firebaseapp.com",
    projectId: "scioport",
    storageBucket: "scioport.appspot.com",
    messagingSenderId: "612919891675",
    appId: "1:612919891675:web:3adef562f38e26c80e5efe",
    measurementId: "G-7BW8NQ1VKC"
  };

  const GUIDE_EMAILS = [
    "oliver.bocko@scioskola.cz",
    "tobias.pokorny@scioskola.cz",
    "jiri.prevorovsky@scioskola.cz"
  ];

  const loginUrl = new URL("login/index.html", window.location.href).toString();
  const homeUrl = new URL("index.html", window.location.href).toString();
  const THEME_STORAGE_KEY = "scioport-admin-theme";
  const DASHBOARD_NOTIF_SEEN_LIMIT = 800;

  let currentUser = null;
  let db = null;
  let templatesRef = null;
  let usersRef = null;
  let subjectsRef = null;
  let currentView = "newTemplate";
  let recipientDirectory = { students: [], classes: [] };
  let subjectDirectory = [];
  let studentOverviewStudents = [];
  let studentOverviewSelectedEmail = "";
  const studentOverviewCache = new Map();

  function hasGuideAccess(email) {
    return GUIDE_EMAILS.indexOf(String(email || "").toLowerCase()) >= 0;
  }

  function getInitialTheme() {
    try {
      const stored = localStorage.getItem(THEME_STORAGE_KEY);
      if (stored === "dark" || stored === "light") {
        return stored;
      }
    } catch (error) {
      // ignore storage errors
    }
    const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
    return prefersDark ? "dark" : "light";
  }

  function applyTheme(theme) {
    const nextTheme = theme === "dark" ? "dark" : "light";
    document.body.setAttribute("data-theme", nextTheme);
    try {
      localStorage.setItem(THEME_STORAGE_KEY, nextTheme);
    } catch (error) {
      // ignore storage errors
    }
    const button = $("#btnTheme");
    if (!button) {
      return;
    }
    const isDark = nextTheme === "dark";
    button.textContent = isDark ? "☀️ Světlý režim" : "🌙 Tmavý režim";
    button.setAttribute("aria-pressed", isDark ? "true" : "false");
    button.title = isDark ? "Přepnout na světlý režim" : "Přepnout na tmavý režim";
  }

  function setHeader(title, subtitle) {
    const titleEl = $("#viewTitle");
    const subEl = $("#viewSub");
    if (titleEl) {
      titleEl.textContent = title;
    }
    if (subEl) {
      subEl.textContent = subtitle;
    }
  }

  function setNavActive(view) {
    const buttons = document.querySelectorAll("#nav button[data-view]");
    for (let i = 0; i < buttons.length; i += 1) {
      const button = buttons[i];
      if (button.dataset && button.dataset.view === view) {
        button.classList.add("active");
      } else {
        button.classList.remove("active");
      }
    }
  }

  function syncSidebarVisibility() {
    const app = $(".app");
    if (!app) {
      return;
    }
    app.classList.remove("sidebar-collapsed");
  }

  function showContentMessage(title, text) {
    const content = $("#content");
    if (!content) {
      return;
    }
    content.innerHTML =
      '<div class="card">' +
      '<h3>' + esc(title) + '</h3>' +
      '<div class="cardBody">' + esc(text) + '</div>' +
      '</div>';
  }

  function normalizeEmail(value) {
    return String(value || "").trim().toLowerCase();
  }

  function normalizeClassName(value) {
    return String(value || "").trim();
  }

  function normalizeSubjectName(value) {
    return String(value || "").replace(/^@+/, "").trim();
  }

  function normalizeSearchText(value) {
    return String(value || "")
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .trim();
  }

  function normalizeCategorySlug(value) {
    return normalizeSearchText(value)
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/^-+|-+$/g, "");
  }

  const CATEGORY_EMOJI_MAP = {
    matematika: ":abacus:",
    cestina: ":books:",
    ceskyjazyk: ":books:",
    "cesky-jazyk": ":books:",
    anglictina: ":globe_with_meridians:",
    samorost: ":seedling:",
    vlastni: ":sparkles:",
    zvdavost: ":bulb:",
    zvidavost: ":bulb:",
    zvedavost: ":bulb:",
    hodnoty: ":heart:",
    moralnihodnoty: ":heart:",
    "moralni-hodnoty": ":heart:",
    samostatnost: ":muscle:"
  };

  function formatCategoryEmoji(value) {
    const slug = normalizeCategorySlug(value);
    const compactSlug = slug.replace(/-/g, "");
    if (!compactSlug) {
      return ":house:";
    }
    return CATEGORY_EMOJI_MAP[slug] || CATEGORY_EMOJI_MAP[compactSlug] || ":house:";
  }

  function getSubjects() {
    const base = subjectDirectory.slice();
    if (base.indexOf("Vlastní...") < 0) {
      base.push("Vlastní...");
    }
    return base;
  }

  function getPillars() {
    return ["Zvídavost", "Hodnoty", "Samostatnost"];
  }

  function renderNewTemplate() {
    const subjects = getSubjects();
    const pillars = getPillars();
    const students = Array.isArray(recipientDirectory.students) ? recipientDirectory.students : [];
    const classes = Array.isArray(recipientDirectory.classes) ? recipientDirectory.classes : [];
    const defaultSubjects = subjects.filter(function (subject) {
      return subject !== "Vlastní...";
    });

    return (
      '<div class="card">' +
      '<h3>Nová šablona</h3>' +
      '<div class="cardBody">' +
      '<div class="composeWrap">' +
      '<div class="composeGrid">' +
      '<div class="composeCol12">' +
      '<label for="tplTitle">Název šablony</label>' +
      '<input id="tplTitle" type="text" placeholder="Např. Horizont - reflexe měsíce">' +
      '</div>' +
      '<div class="composeCol6">' +
      '<label for="tplAnno">Anotace</label>' +
      '<textarea id="tplAnno" placeholder="Co děti budou dělat a proč..."></textarea>' +
      '</div>' +
      '<div class="composeCol6">' +
      '<label for="tplOut">Očekávaný výstup</label>' +
      '<textarea id="tplOut" placeholder="Jak má vypadat výstup (stručně, konkrétně)..."></textarea>' +
      '</div>' +
      '<div class="composeCol6">' +
      '<label>Předměty</label>' +
      '<div class="composeCheckList">' +
      defaultSubjects.map(function (subject, index) {
        const checked = index === 0 ? ' checked' : '';
        const subjectEmoji = formatCategoryEmoji(subject);
        return '<label class="composeCheckItem"><input class="tpl-subject" type="checkbox" value="' + esc(subject) + '"' + checked + '><span title="' + esc(subject) + '">' + esc(subjectEmoji) + '</span></label>';
      }).join("") +
      '</div>' +
      '<input id="tplSubjectsCustom" type="text" placeholder="Vlastní předměty odděl čárkou">' +
      '<p class="composeHint">Můžeš zaškrtnout více předmětů naráz.</p>' +
      '</div>' +
      '<div class="composeCol6">' +
      '<label>Pilíře</label>' +
      '<div class="composeCheckList">' +
      pillars.map(function (pillar) {
        const checked = pillar === "Zvídavost" ? ' checked' : '';
        const pillarEmoji = formatCategoryEmoji(pillar);
        return '<label class="composeCheckItem"><input class="tpl-pillar" type="checkbox" value="' + esc(pillar) + '"' + checked + '><span title="' + esc(pillar) + '">' + esc(pillarEmoji) + '</span></label>';
      }).join("") +
      '</div>' +
      '<p class="composeHint">Můžeš vybrat více pilířů.</p>' +
      '</div>' +
      '</div>' +
      '<hr class="composeDivider">' +
      '<p class="composeSub">Komu poslat</p>' +
      '<p class="composeHint">Zaškrtni libovolnou kombinaci dětí a tříd. Odeslání vytvoří assignment pro všechny vybrané příjemce.</p>' +
      '<div class="composeGrid" style="margin-top:8px">' +
      '<div class="composeCol6">' +
      '<label>Žáci</label>' +
      (students.length
        ? '<input id="tplStudentFilter" class="composeFilterInput" type="text" placeholder="Filtrovat podle jména nebo e-mailu">' +
          '<div class="composeCheckList" id="tplStudentList">' +
          students.map(function (student) {
            const name = String(student.name || "").trim();
            const classPart = student.className ? " - " + student.className : "";
            const label = (name ? name + " (" + student.email + ")" : student.email) + classPart;
            const searchText = normalizeSearchText((name ? name + " " : "") + student.email + " " + (student.className || ""));
            return '<label class="composeCheckItem tpl-student-item" data-search="' + esc(searchText) + '"><input class="tpl-student" type="checkbox" value="' + esc(student.email) + '"><span>' + esc(label) + '</span></label>';
          }).join("") +
          '</div>' +
          '<div class="composeCheckEmpty filterEmpty hidden" id="tplStudentFilterEmpty">Žádný žák neodpovídá filtru.</div>'
        : '<div class="composeCheckEmpty">V databázi zatím nejsou žádní žáci.</div>') +
      '</div>' +
      '<div class="composeCol6">' +
      '<label>Třídy</label>' +
      (classes.length
        ? '<div class="composeCheckList">' +
          classes.map(function (className) {
            return '<label class="composeCheckItem"><input class="tpl-class" type="checkbox" value="' + esc(className) + '"><span>' + esc(className) + '</span></label>';
          }).join("") +
          '</div>'
        : '<div class="composeCheckEmpty">V databázi zatím nejsou žádné třídy.</div>') +
      '<p class="composeHint">Můžeš zvolit více tříd i více jednotlivých žáků.</p>' +
      '</div>' +
      '</div>' +
      '<div class="composeActions">' +
      '<button class="btn" id="saveTpl" type="button">Uložit lokálně</button>' +
      '<button class="btn primary" id="saveSendTpl" type="button">Odeslat šablonu</button>' +
      '</div>' +
      '</div>' +
      '</div>' +
      '</div>'
    );
  }

  function renderPlaceholder(view) {
    const labels = {
      dashboard: ["Dashboard", "Správa šablon"],
      myTemplates: ["Moje šablony", "Historie odeslání"],
      classes: ["Třídy", "Správa tříd"],
      studentOverview: ["Přehled dítěte", "Přehled odpovědí"],
      notifications: ["Notifikace", "Stav vyplnění"]
    };
    const label = labels[view] || ["Admin", "Správa"];
    setHeader(label[0], label[1]);
    showContentMessage(label[0], "Tato část bude doplněna. Pro odeslání použij Novou šablonu.");
  }

  function normalizePortfolioText(value) {
    return String(value || "")
      .replace(/<a\s+[^>]*>(.*?)<\/a>/gi, "$1")
      .replace(/<[^>]+>/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function extractSubjectsFromPortfolioValue(value) {
    const matches = String(value || "").match(/@[^\s,.;:!?]+/g) || [];
    return uniqueValues(matches.map(function (item) {
      return normalizeSubjectName(item);
    }).filter(Boolean));
  }

  function renderStudentOverviewLayout(students, selectedEmail) {
    const items = Array.isArray(students) ? students : [];
    const normalizedSelectedEmail = normalizeEmail(selectedEmail);
    return (
      '<div class="split">' +
      '<div class="card">' +
      '<h3>Přehled dítěte</h3>' +
      '<div class="cardBody">' +
      '<input id="studentOverviewSearch" type="text" placeholder="Hledat podle jména, e-mailu nebo třídy">' +
      '<div style="margin-top:10px" id="studentOverviewList">' +
      items.map(function (student) {
        const email = normalizeEmail(student && student.email ? student.email : "");
        const className = normalizeClassName(student && student.className ? student.className : "");
        const name = getStudentDisplayName(student);
        const searchText = normalizeSearchText(name + " " + email + " " + className);
        const activeClass = email === normalizedSelectedEmail ? " active" : "";
        return (
          '<button class="classBtn studentOverviewBtn' + activeClass + '" type="button" data-email="' + esc(email) + '" data-search="' + esc(searchText) + '">' +
          '<div class="title">' + esc(name) + '</div>' +
          '<div class="hint">' + esc(email) + (className ? " - " + esc(className) : "") + '</div>' +
          '</button>'
        );
      }).join("") +
      '</div>' +
      '<div class="empty hidden" id="studentOverviewEmpty">Žádný žák neodpovídá filtru.</div>' +
      '</div>' +
      '</div>' +
      '<div id="studentOverviewDetail">' +
      '<div class="card">' +
      '<h3>Portfolio</h3>' +
      '<div class="cardBody">Vyber žáka vlevo.</div>' +
      '</div>' +
      '</div>' +
      '</div>'
    );
  }

  function filterStudentOverviewList(filterValue) {
    const list = $("#studentOverviewList");
    if (!list) {
      return;
    }
    const query = normalizeSearchText(filterValue);
    const items = list.querySelectorAll(".studentOverviewBtn");
    let visibleCount = 0;
    for (let i = 0; i < items.length; i += 1) {
      const item = items[i];
      const searchText = String(item.dataset && item.dataset.search ? item.dataset.search : "");
      const visible = !query || searchText.indexOf(query) >= 0;
      item.style.display = visible ? "" : "none";
      if (visible) {
        visibleCount += 1;
      }
    }
    const empty = $("#studentOverviewEmpty");
    if (empty) {
      empty.classList.toggle("hidden", visibleCount > 0);
    }
  }

  async function resolveUserDocRefByStudent(student) {
    if (!usersRef || !student) {
      return null;
    }
    const uid = String(student.uid || "").trim();
    if (uid) {
      return usersRef.doc(uid);
    }
    const email = normalizeEmail(student.email || "");
    if (!email) {
      return null;
    }
    try {
      let snapshot = await usersRef.where("emailLower", "==", email).limit(1).get();
      if (snapshot.empty) {
        snapshot = await usersRef.where("email", "==", email).limit(1).get();
      }
      if (!snapshot.empty) {
        return snapshot.docs[0].ref;
      }
    } catch (error) {
      console.warn("Student overview email lookup failed:", error);
    }
    return null;
  }

  async function loadStudentPortfolio(student) {
    const userRef = await resolveUserDocRefByStudent(student);
    if (!userRef) {
      return { entries: [], responses: [] };
    }

    const entries = [];
    const responses = [];

    try {
      let dataSnapshot;
      try {
        dataSnapshot = await userRef.collection("data").orderBy("timestamp", "desc").limit(200).get();
      } catch (error) {
        dataSnapshot = await userRef.collection("data").limit(200).get();
      }
      dataSnapshot.forEach(function (doc) {
        const data = doc.data() || {};
        const rawValue = String(data.value || "").trim();
        const text = normalizePortfolioText(rawValue);
        const subjects = collectTemplateValues(data, "subjects", "subject");
        const pillars = collectTemplateValues(data, "pillars", "pillar");
        const derivedSubjects = subjects.length ? subjects : extractSubjectsFromPortfolioValue(rawValue);
        const timestampMillis = toMillis(data.timestamp || data.updatedAt || data.createdAt || 0);
        entries.push({
          id: doc.id,
          text: text,
          subjects: derivedSubjects,
          pillars: pillars,
          timestampMillis: timestampMillis
        });
      });
    } catch (error) {
      console.error("Student overview data load failed:", error);
    }

    try {
      let responseSnapshot;
      try {
        responseSnapshot = await userRef.collection("templateResponses").orderBy("updatedAt", "desc").limit(200).get();
      } catch (error) {
        responseSnapshot = await userRef.collection("templateResponses").limit(200).get();
      }
      responseSnapshot.forEach(function (doc) {
        const data = doc.data() || {};
        responses.push({
          id: doc.id,
          templateTitle: String(data.templateTitle || data.title || "Bez názvu").trim(),
          response: String(data.response || data.value || "").trim(),
          subjects: collectTemplateValues(data, "subjects", "subject"),
          pillars: collectTemplateValues(data, "pillars", "pillar"),
          updatedAtMillis: toMillis(data.updatedAt || data.timestamp || data.createdAt || 0)
        });
      });
    } catch (error) {
      console.error("Student overview responses load failed:", error);
    }

    entries.sort(function (a, b) {
      return (b.timestampMillis || 0) - (a.timestampMillis || 0);
    });
    responses.sort(function (a, b) {
      return (b.updatedAtMillis || 0) - (a.updatedAtMillis || 0);
    });

    return {
      entries: entries,
      responses: responses
    };
  }

  function renderStudentPortfolioEntries(entries) {
    const items = Array.isArray(entries) ? entries : [];
    if (!items.length) {
      return '<div class="empty">Žák zatím nemá žádné portfolio záznamy.</div>';
    }
    return (
      '<div class="list">' +
      items.slice(0, 80).map(function (item) {
        const text = String(item.text || "").trim();
        const dateLabel = formatDateTime(item.timestampMillis);
        const subjectBadges = (item.subjects || []).slice(0, 3).map(function (subject) {
          return '<span class="badge" title="' + esc(subject) + '">' + esc(formatCategoryEmoji(subject)) + '</span>';
        }).join("");
        const pillarBadges = (item.pillars || []).slice(0, 3).map(function (pillar) {
          return '<span class="badge" title="' + esc(pillar) + '">' + esc(formatCategoryEmoji(pillar)) + '</span>';
        }).join("");
        return (
          '<article class="item">' +
          '<div>' +
          '<div class="title">' + esc(text || "Bez obsahu") + '</div>' +
          '<div class="meta">' +
          (dateLabel ? '<span class="badge">' + esc(dateLabel) + '</span>' : "") +
          subjectBadges +
          pillarBadges +
          '</div>' +
          '</div>' +
          '</article>'
        );
      }).join("") +
      '</div>'
    );
  }

  function renderStudentTemplateResponses(responses) {
    const items = Array.isArray(responses) ? responses : [];
    if (!items.length) {
      return '<div class="empty">Žák zatím neodeslal žádné odpovědi na šablony.</div>';
    }
    return (
      '<div class="list">' +
      items.slice(0, 80).map(function (item) {
        const title = String(item.templateTitle || "Bez názvu").trim();
        const value = String(item.response || "").trim();
        const dateLabel = formatDateTime(item.updatedAtMillis);
        const subjectBadges = (item.subjects || []).slice(0, 3).map(function (subject) {
          return '<span class="badge" title="' + esc(subject) + '">' + esc(formatCategoryEmoji(subject)) + '</span>';
        }).join("");
        const pillarBadges = (item.pillars || []).slice(0, 3).map(function (pillar) {
          return '<span class="badge" title="' + esc(pillar) + '">' + esc(formatCategoryEmoji(pillar)) + '</span>';
        }).join("");
        return (
          '<article class="item">' +
          '<div>' +
          '<div class="title">' + esc(title) + '</div>' +
          '<div class="hint" style="margin-top:4px">' + esc(value || "Bez textu odpovědi") + '</div>' +
          '<div class="meta">' +
          (dateLabel ? '<span class="badge">' + esc(dateLabel) + '</span>' : "") +
          subjectBadges +
          pillarBadges +
          '</div>' +
          '</div>' +
          '</article>'
        );
      }).join("") +
      '</div>'
    );
  }

  function renderStudentOverviewDetail(student, portfolio) {
    const data = portfolio || { entries: [], responses: [] };
    const name = getStudentDisplayName(student);
    const email = normalizeEmail(student && student.email ? student.email : "");
    const className = normalizeClassName(student && student.className ? student.className : "");
    const entries = Array.isArray(data.entries) ? data.entries : [];
    const responses = Array.isArray(data.responses) ? data.responses : [];

    return (
      '<div class="card">' +
      '<h3>Portfolio žáka</h3>' +
      '<div class="cardBody">' +
      '<div class="title">' + esc(name) + '</div>' +
      '<div class="meta">' +
      (email ? '<span class="badge">' + esc(email) + '</span>' : "") +
      (className ? '<span class="badge ok">Třída: ' + esc(className) + '</span>' : "") +
      '<span class="badge">Záznamy: ' + String(entries.length) + '</span>' +
      '<span class="badge">Odpovědi: ' + String(responses.length) + '</span>' +
      '</div>' +
      '<hr class="composeDivider">' +
      '<h3>Portfolio záznamy</h3>' +
      renderStudentPortfolioEntries(entries) +
      '<hr class="composeDivider">' +
      '<h3>Odpovědi na šablony</h3>' +
      renderStudentTemplateResponses(responses) +
      '</div>' +
      '</div>'
    );
  }

  function setStudentOverviewActive(email) {
    const normalized = normalizeEmail(email);
    const buttons = document.querySelectorAll(".studentOverviewBtn");
    for (let i = 0; i < buttons.length; i += 1) {
      const button = buttons[i];
      const buttonEmail = normalizeEmail(button.dataset && button.dataset.email ? button.dataset.email : "");
      button.classList.toggle("active", Boolean(normalized) && buttonEmail === normalized);
    }
  }

  async function openStudentOverviewStudent(email) {
    const normalizedEmail = normalizeEmail(email);
    if (!normalizedEmail) {
      return;
    }
    studentOverviewSelectedEmail = normalizedEmail;
    setStudentOverviewActive(normalizedEmail);

    const detail = $("#studentOverviewDetail");
    if (!detail) {
      return;
    }

    const selectedStudent = studentOverviewStudents.find(function (student) {
      return normalizeEmail(student && student.email ? student.email : "") === normalizedEmail;
    });

    if (!selectedStudent) {
      detail.innerHTML =
        '<div class="card">' +
        '<h3>Portfolio</h3>' +
        '<div class="cardBody empty">Vybraného žáka se nepodařilo načíst.</div>' +
        '</div>';
      return;
    }

    detail.innerHTML =
      '<div class="card">' +
      '<h3>Portfolio žáka</h3>' +
      '<div class="cardBody">Načítám portfolio…</div>' +
      '</div>';

    let portfolio = studentOverviewCache.get(normalizedEmail);
    if (!portfolio) {
      portfolio = await loadStudentPortfolio(selectedStudent);
      studentOverviewCache.set(normalizedEmail, portfolio);
    }

    if (currentView !== "studentOverview") {
      return;
    }
    detail.innerHTML = renderStudentOverviewDetail(selectedStudent, portfolio);
  }

  function bindStudentOverviewEvents() {
    const searchInput = $("#studentOverviewSearch");
    if (searchInput) {
      searchInput.addEventListener("input", function () {
        filterStudentOverviewList(searchInput.value);
      });
      filterStudentOverviewList(searchInput.value);
    }

    const list = $("#studentOverviewList");
    if (list) {
      list.addEventListener("click", function (event) {
        const button = event.target && event.target.closest ? event.target.closest(".studentOverviewBtn") : null;
        if (!button || !button.dataset) {
          return;
        }
        const email = String(button.dataset.email || "").trim();
        openStudentOverviewStudent(email);
      });
    }
  }

  async function renderStudentOverviewView() {
    const content = $("#content");
    if (!content) {
      return;
    }

    content.innerHTML =
      '<div class="card">' +
      '<h3>Přehled dítěte</h3>' +
      '<div class="cardBody">Načítám žáky a portfolio…</div>' +
      '</div>';

    await loadRecipientDirectory();
    const students = Array.isArray(recipientDirectory.students)
      ? recipientDirectory.students.slice()
      : [];
    studentOverviewStudents = students;
    studentOverviewCache.clear();

    if (currentView !== "studentOverview") {
      return;
    }

    if (!students.length) {
      content.innerHTML =
        '<div class="card">' +
        '<h3>Přehled dítěte</h3>' +
        '<div class="cardBody empty">V databázi zatím nejsou žádní žáci.</div>' +
        '</div>';
      return;
    }

    const hasSelected = students.some(function (student) {
      return normalizeEmail(student && student.email ? student.email : "") === normalizeEmail(studentOverviewSelectedEmail);
    });
    if (!hasSelected) {
      studentOverviewSelectedEmail = normalizeEmail(students[0].email);
    }

    content.innerHTML = renderStudentOverviewLayout(students, studentOverviewSelectedEmail);
    bindStudentOverviewEvents();
    await openStudentOverviewStudent(studentOverviewSelectedEmail);
  }

  function uniqueValues(values) {
    const result = [];
    const seen = new Set();
    if (!Array.isArray(values)) {
      return result;
    }
    for (let i = 0; i < values.length; i += 1) {
      const value = String(values[i] || "").trim();
      if (!value) {
        continue;
      }
      const key = value.toLowerCase();
      if (seen.has(key)) {
        continue;
      }
      seen.add(key);
      result.push(value);
    }
    return result;
  }

  function splitCommaValues(value) {
    return uniqueValues(String(value || "").split(",").map(function (item) {
      return item.trim();
    }));
  }

  function getCheckedValues(selector) {
    const nodes = document.querySelectorAll(selector);
    const values = [];
    for (let i = 0; i < nodes.length; i += 1) {
      const node = nodes[i];
      if (node && node.checked) {
        values.push(String(node.value || "").trim());
      }
    }
    return uniqueValues(values);
  }

  function filterTemplateStudents(filterValue) {
    const list = $("#tplStudentList");
    if (!list) {
      return;
    }
    const query = normalizeSearchText(filterValue);
    const items = list.querySelectorAll(".tpl-student-item");
    let visibleCount = 0;
    for (let i = 0; i < items.length; i += 1) {
      const item = items[i];
      const searchable = String(item.dataset && item.dataset.search ? item.dataset.search : "");
      const isVisible = !query || searchable.indexOf(query) >= 0;
      item.style.display = isVisible ? "" : "none";
      if (isVisible) {
        visibleCount += 1;
      }
    }
    const empty = $("#tplStudentFilterEmpty");
    if (empty) {
      empty.classList.toggle("hidden", visibleCount > 0);
    }
  }

  function bindTemplateEvents() {
    const saveLocalButton = $("#saveTpl");
    const sendButton = $("#saveSendTpl");
    const studentFilterInput = $("#tplStudentFilter");

    if (saveLocalButton) {
      saveLocalButton.addEventListener("click", function () {
        handleTemplateSave(false);
      });
    }

    if (sendButton) {
      sendButton.addEventListener("click", function () {
        handleTemplateSave(true);
      });
    }

    if (studentFilterInput) {
      studentFilterInput.addEventListener("input", function () {
        filterTemplateStudents(studentFilterInput.value);
      });
      filterTemplateStudents(studentFilterInput.value);
    }
  }

  function getFormData() {
    const title = String(("#tplTitle" && $("#tplTitle") ? $("#tplTitle").value : "") || "").trim();
    const annotation = String(("#tplAnno" && $("#tplAnno") ? $("#tplAnno").value : "") || "").trim();
    const output = String(("#tplOut" && $("#tplOut") ? $("#tplOut").value : "") || "").trim();
    const subjectsCustom = String(("#tplSubjectsCustom" && $("#tplSubjectsCustom") ? $("#tplSubjectsCustom").value : "") || "").trim();
    const selectedSubjects = getCheckedValues(".tpl-subject");
    const customSubjects = splitCommaValues(subjectsCustom);
    const subjects = uniqueValues(selectedSubjects.concat(customSubjects));
    const pillars = getCheckedValues(".tpl-pillar");
    const studentEmails = uniqueValues(getCheckedValues(".tpl-student").map(function (email) {
      return normalizeEmail(email);
    }));
    const classNames = uniqueValues(getCheckedValues(".tpl-class").map(function (className) {
      return normalizeClassName(className);
    }));

    return {
      title,
      annotation,
      output,
      subject: subjects.length ? subjects[0] : "",
      subjects: subjects,
      pillar: pillars.length ? pillars[0] : "",
      pillars: pillars,
      studentEmails: studentEmails,
      classNames: classNames
    };
  }

  function validateForm(data, isSend) {
    if (!data.title || !data.annotation || !data.output) {
      return "Doplň název, anotaci a očekávaný výstup.";
    }
    if (!data.subjects || !data.subjects.length) {
      return "Vyber aspoň jeden předmět.";
    }
    if (!data.pillars || !data.pillars.length) {
      return "Vyber aspoň jeden pilíř.";
    }

    const invalidEmail = (data.studentEmails || []).find(function (email) {
      return email.indexOf("@") < 0;
    });
    if (invalidEmail) {
      return "Neplatný e-mail žáka: " + invalidEmail;
    }

    if (!isSend) {
      return "";
    }

    if (!(data.studentEmails.length || data.classNames.length)) {
      return "Vyber aspoň jednoho příjemce (žák/třída).";
    }

    return "";
  }

  function clearForm() {
    const ids = ["tplTitle", "tplAnno", "tplOut", "tplSubjectsCustom", "tplStudentFilter"];
    for (let i = 0; i < ids.length; i += 1) {
      const input = $("#" + ids[i]);
      if (input) {
        input.value = "";
      }
    }

    const checkboxes = document.querySelectorAll(".tpl-subject, .tpl-pillar, .tpl-student, .tpl-class");
    for (let i = 0; i < checkboxes.length; i += 1) {
      checkboxes[i].checked = false;
    }

    const defaultSubject = document.querySelector(".tpl-subject");
    if (defaultSubject) {
      defaultSubject.checked = true;
    }

    const defaultPillar = document.querySelector('.tpl-pillar[value="Zvídavost"]');
    if (defaultPillar) {
      defaultPillar.checked = true;
    }

    filterTemplateStudents("");
  }

  function buildRecipientTargets(data) {
    const targetMap = new Map();

    (data.studentEmails || []).forEach(function (email) {
      const normalized = normalizeEmail(email);
      if (!normalized) {
        return;
      }
      targetMap.set("student|" + normalized, {
        recipientType: "student",
        recipientValue: normalized
      });
    });

    (data.classNames || []).forEach(function (className) {
      const normalized = normalizeClassName(className);
      if (!normalized) {
        return;
      }
      const key = "class|" + normalized.toLowerCase();
      targetMap.set(key, {
        recipientType: "class",
        recipientValue: normalized
      });
    });

    return Array.from(targetMap.values());
  }

  function getStudentWord(count) {
    if (count === 1) {
      return "žák";
    }
    if (count >= 2 && count <= 4) {
      return "žáci";
    }
    return "žáků";
  }

  function getStudentDisplayName(student) {
    const name = String(student && student.name ? student.name : "").trim();
    if (name) {
      return name;
    }
    const email = String(student && student.email ? student.email : "").trim();
    if (!email) {
      return "Neznámý žák";
    }
    const local = email.split("@")[0] || email;
    return local.trim() || email;
  }

  function buildClassGroups(students) {
    const groups = new Map();
    const source = Array.isArray(students) ? students : [];
    source.forEach(function (student) {
      const className = normalizeClassName(student && student.className ? student.className : "");
      if (!className) {
        return;
      }
      if (!groups.has(className)) {
        groups.set(className, []);
      }
      groups.get(className).push(student);
    });

    return Array.from(groups.entries())
      .map(function (entry) {
        const className = entry[0];
        const classStudents = entry[1] || [];
        const names = classStudents.map(function (student) {
          return getStudentDisplayName(student);
        }).filter(Boolean).sort(function (a, b) {
          return a.localeCompare(b, "cs");
        });
        return {
          className: className,
          studentCount: classStudents.length,
          names: names
        };
      })
      .sort(function (a, b) {
        return a.className.localeCompare(b.className, "cs");
      });
  }

  function renderClassesList(groups) {
    const classGroups = Array.isArray(groups) ? groups : [];
    const totalStudents = classGroups.reduce(function (sum, group) {
      return sum + (group && group.studentCount ? group.studentCount : 0);
    }, 0);

    if (!classGroups.length) {
      return (
        '<div class="card">' +
        '<h3>Třídy</h3>' +
        '<div class="cardBody empty">Zatím nejsou přiřazené žádné třídy ani žáci.</div>' +
        '</div>'
      );
    }

    return (
      '<div class="card">' +
      '<h3>Třídy</h3>' +
      '<div class="cardBody">' +
      '<div class="meta">' +
      '<span class="badge ok">Třídy: ' + String(classGroups.length) + '</span>' +
      '<span class="badge">Žáci celkem: ' + String(totalStudents) + '</span>' +
      '</div>' +
      '<div class="list">' +
      classGroups.map(function (group) {
        const namesBadges = (group.names || []).map(function (name) {
          return '<span class="badge">' + esc(name) + '</span>';
        }).join("");
        return (
          '<div class="item">' +
          '<div>' +
          '<div class="title">' + esc(group.className) + '</div>' +
          '<div class="meta"><span class="badge ok">' + String(group.studentCount) + " " + getStudentWord(group.studentCount) + '</span></div>' +
          (namesBadges
            ? '<div class="meta">' + namesBadges + '</div>'
            : '<div class="hint">Třída zatím nemá přiřazená jména.</div>') +
          '</div>' +
          '</div>'
        );
      }).join("") +
      '</div>' +
      '</div>' +
      '</div>'
    );
  }

  async function renderClassesView() {
    const content = $("#content");
    if (!content) {
      return;
    }

    content.innerHTML =
      '<div class="card">' +
      '<h3>Třídy</h3>' +
      '<div class="cardBody">Načítám třídy…</div>' +
      '</div>';

    await loadRecipientDirectory();
    const groups = buildClassGroups(recipientDirectory.students);
    const pillClasses = $("#pillClasses");
    if (pillClasses) {
      pillClasses.textContent = String(groups.length);
    }

    if (currentView !== "classes") {
      return;
    }
    content.innerHTML = renderClassesList(groups);
  }

  function toMillis(value) {
    if (!value && value !== 0) {
      return 0;
    }
    if (typeof value === "number" && Number.isFinite(value)) {
      return value;
    }
    if (value && typeof value.toMillis === "function") {
      return value.toMillis();
    }
    const date = new Date(value);
    return Number.isNaN(date.getTime()) ? 0 : date.getTime();
  }

  function getWeekStartMillis(baseMillis) {
    const date = new Date(baseMillis || Date.now());
    const day = date.getDay();
    const diff = day === 0 ? 6 : day - 1;
    date.setHours(0, 0, 0, 0);
    date.setDate(date.getDate() - diff);
    return date.getTime();
  }

  function getDashboardNotificationSeenKey() {
    const uid = currentUser && currentUser.uid ? currentUser.uid : "guest";
    return "scioport-admin-notif-seen-" + uid;
  }

  function loadDashboardNotificationSeenSet() {
    const seen = new Set();
    try {
      const raw = localStorage.getItem(getDashboardNotificationSeenKey());
      const parsed = raw ? JSON.parse(raw) : [];
      if (Array.isArray(parsed)) {
        parsed.forEach(function (item) {
          const value = String(item || "").trim();
          if (value) {
            seen.add(value);
          }
        });
      }
    } catch (error) {
      // ignore storage errors
    }
    return seen;
  }

  function saveDashboardNotificationSeenSet(seenSet) {
    if (!(seenSet instanceof Set)) {
      return;
    }
    const values = Array.from(seenSet.values()).slice(-DASHBOARD_NOTIF_SEEN_LIMIT);
    try {
      localStorage.setItem(getDashboardNotificationSeenKey(), JSON.stringify(values));
    } catch (error) {
      // ignore storage errors
    }
  }

  function markDashboardNotificationsSeen(keys) {
    if (!Array.isArray(keys) || !keys.length) {
      return;
    }
    const seen = loadDashboardNotificationSeenSet();
    let changed = false;
    keys.forEach(function (key) {
      const value = String(key || "").trim();
      if (!value || seen.has(value)) {
        return;
      }
      seen.add(value);
      changed = true;
    });
    if (changed) {
      saveDashboardNotificationSeenSet(seen);
    }
  }

  function collectTemplateIdsFromGroups(templateGroups) {
    const ids = new Set();
    (Array.isArray(templateGroups) ? templateGroups : []).forEach(function (group) {
      (group && Array.isArray(group.templateIds) ? group.templateIds : []).forEach(function (templateId) {
        const value = String(templateId || "").trim();
        if (value) {
          ids.add(value);
        }
      });
    });
    return Array.from(ids.values());
  }

  async function loadDashboardResponses(templateIds) {
    const ids = [];
    const seenIds = new Set();
    (Array.isArray(templateIds) ? templateIds : []).forEach(function (templateId) {
      const value = String(templateId || "").trim();
      if (!value || seenIds.has(value)) {
        return;
      }
      seenIds.add(value);
      ids.push(value);
    });
    if (!db) {
      return [];
    }

    const idSet = new Set(ids);

    function normalizeResponseDocs(snapshot) {
      const values = [];
      snapshot.forEach(function (doc) {
        const data = doc.data() || {};
        const templateId = String(data.templateId || doc.id || "").trim();
        if (!templateId) {
          return;
        }
        const updatedAtMillis = toMillis(data.updatedAt);
        let userId = String(data.userId || "").trim();
        if (!userId && doc.ref && doc.ref.parent && doc.ref.parent.parent) {
          userId = String(doc.ref.parent.parent.id || "").trim();
        }
        const userEmail = normalizeEmail(data.userEmail || "");
        const subjects = Array.isArray(data.subjects)
          ? data.subjects.map(function (item) { return String(item || "").trim(); }).filter(Boolean)
          : (data.subject ? [String(data.subject || "").trim()].filter(Boolean) : []);
        const pillars = Array.isArray(data.pillars)
          ? data.pillars.map(function (item) { return String(item || "").trim(); }).filter(Boolean)
          : (data.pillar ? [String(data.pillar || "").trim()] : []);
        const responseKey = [userId || userEmail || "user", templateId, String(updatedAtMillis || 0)].join("|");
        values.push({
          responseKey: responseKey,
          templateId: templateId,
          templateTitle: String(data.templateTitle || "").trim(),
          userId: userId,
          userEmail: userEmail,
          subjects: subjects,
          pillars: pillars,
          updatedAtMillis: updatedAtMillis
        });
      });
      return values;
    }

    async function loadResponsesFromUsersSubcollections() {
      if (!usersRef) {
        return [];
      }

      const userSnapshot = await usersRef.get();
      const userDocs = [];
      userSnapshot.forEach(function (doc) {
        userDocs.push(doc);
      });

      const values = [];
      const chunkSize = 15;
      for (let offset = 0; offset < userDocs.length; offset += chunkSize) {
        const chunk = userDocs.slice(offset, offset + chunkSize);
        const chunkValues = await Promise.all(chunk.map(async function (userDoc) {
          try {
            const responseSnapshot = await userDoc.ref.collection("templateResponses").get();
            return normalizeResponseDocs(responseSnapshot);
          } catch (error) {
            return [];
          }
        }));
        chunkValues.forEach(function (list) {
          if (!Array.isArray(list) || !list.length) {
            return;
          }
          for (let i = 0; i < list.length; i += 1) {
            values.push(list[i]);
          }
        });
      }

      if (!idSet.size) {
        return values;
      }
      return values.filter(function (item) {
        return idSet.has(item.templateId);
      });
    }

    const chunkSize = 10;
    let responses = [];

    try {
      if (ids.length) {
        for (let offset = 0; offset < ids.length; offset += chunkSize) {
          const chunk = ids.slice(offset, offset + chunkSize);
          if (!chunk.length) {
            continue;
          }
          const snapshot = await db.collectionGroup("templateResponses").where("templateId", "in", chunk).get();
          responses = responses.concat(normalizeResponseDocs(snapshot));
        }
      }
    } catch (error) {
      responses = [];
    }

    // Fallback 1: přímé čtení users/{uid}/templateResponses bez collectionGroup indexů.
    if (!responses.length) {
      try {
        responses = await loadResponsesFromUsersSubcollections();
      } catch (error) {
        responses = [];
      }
    }

    // Fallback 2: poslední odpovědi obecně.
    if (!responses.length) {
      try {
        const fallbackSnapshot = await db.collectionGroup("templateResponses")
          .orderBy("updatedAt", "desc")
          .limit(200)
          .get();
        const fallbackResponses = normalizeResponseDocs(fallbackSnapshot);
        responses = idSet.size
          ? fallbackResponses.filter(function (item) {
              return idSet.has(item.templateId);
            })
          : fallbackResponses;
      } catch (error) {
        responses = [];
      }
    }

    const deduped = new Map();
    responses.forEach(function (item) {
      const key = String(item && item.responseKey ? item.responseKey : "");
      if (!key) {
        return;
      }
      if (!deduped.has(key)) {
        deduped.set(key, item);
      }
    });
    responses = Array.from(deduped.values());

    responses.sort(function (a, b) {
      return (b.updatedAtMillis || 0) - (a.updatedAtMillis || 0);
    });
    return responses;
  }

  function resolveStudentLabelFromEmail(email, studentByEmail) {
    const normalizedEmail = normalizeEmail(email);
    const student = studentByEmail.get(normalizedEmail);
    if (student) {
      return getStudentDisplayName(student);
    }
    if (normalizedEmail) {
      return normalizedEmail.split("@")[0] || normalizedEmail;
    }
    return "Neznámý žák";
  }

  function pickMostFrequentLabel(sourceValues, fallback) {
    const counts = new Map();
    (Array.isArray(sourceValues) ? sourceValues : []).forEach(function (value) {
      const item = String(value || "").trim();
      if (!item) {
        return;
      }
      counts.set(item, (counts.get(item) || 0) + 1);
    });
    if (!counts.size) {
      return fallback || "—";
    }
    return Array.from(counts.entries()).sort(function (a, b) {
      const countDiff = b[1] - a[1];
      if (countDiff !== 0) {
        return countDiff;
      }
      return a[0].localeCompare(b[0], "cs");
    })[0][0];
  }

  function computeDeliveredRecipients(templateGroup, classMembers) {
    const recipients = templateGroup && Array.isArray(templateGroup.recipientTargets)
      ? templateGroup.recipientTargets
      : [];
    if (!recipients.length) {
      return Number(templateGroup && templateGroup.recipientCount ? templateGroup.recipientCount : 0);
    }

    const expanded = new Set();
    recipients.forEach(function (target) {
      const type = String(target && target.type ? target.type : "").toLowerCase();
      const value = String(target && target.value ? target.value : "").trim();
      if (!value) {
        return;
      }

      if (type === "student") {
        expanded.add(normalizeEmail(value));
        return;
      }

      if (type === "class") {
        const members = classMembers.get(value.toLowerCase());
        if (members && members.size) {
          members.forEach(function (email) {
            expanded.add(email);
          });
        } else {
          expanded.add("class|" + value.toLowerCase());
        }
        return;
      }

      expanded.add(type + "|" + value.toLowerCase());
    });

    return expanded.size;
  }

  function computeDashboardStats(templateGroups, classGroups, responses, seenNotificationSet) {
    const safeTemplates = Array.isArray(templateGroups) ? templateGroups : [];
    const safeClasses = Array.isArray(classGroups) ? classGroups : [];
    const safeResponses = Array.isArray(responses) ? responses : [];
    const seenSet = seenNotificationSet instanceof Set ? seenNotificationSet : new Set();
    const nowMillis = Date.now();
    const weekStartMillis = getWeekStartMillis(nowMillis);
    const studentDirectory = Array.isArray(recipientDirectory.students) ? recipientDirectory.students : [];

    const studentByEmail = new Map();
    const classMembers = new Map();
    studentDirectory.forEach(function (student) {
      const email = normalizeEmail(student && student.email ? student.email : "");
      if (email) {
        studentByEmail.set(email, student);
      }
      const className = normalizeClassName(student && student.className ? student.className : "");
      if (!className || !email) {
        return;
      }
      const key = className.toLowerCase();
      if (!classMembers.has(key)) {
        classMembers.set(key, new Set());
      }
      classMembers.get(key).add(email);
    });

    const templateTitleById = new Map();
    safeTemplates.forEach(function (group) {
      (group && Array.isArray(group.templateIds) ? group.templateIds : []).forEach(function (templateId) {
        const id = String(templateId || "").trim();
        if (id) {
          templateTitleById.set(id, String(group.title || "").trim());
        }
      });
    });

    const responsesNormalized = safeResponses.map(function (response) {
      const templateId = String(response && response.templateId ? response.templateId : "").trim();
      const templateTitle = String(response && response.templateTitle ? response.templateTitle : "").trim()
        || templateTitleById.get(templateId)
        || "Bez názvu";
      const userEmail = normalizeEmail(response && response.userEmail ? response.userEmail : "");
      const updatedAtMillis = toMillis(response && response.updatedAtMillis ? response.updatedAtMillis : 0);
      const responseKey = String(response && response.responseKey ? response.responseKey : "").trim()
        || [userEmail || "user", templateId || "template", String(updatedAtMillis || 0)].join("|");
      return {
        responseKey: responseKey,
        templateId: templateId,
        templateTitle: templateTitle,
        userEmail: userEmail,
        updatedAtMillis: updatedAtMillis,
        subjects: Array.isArray(response && response.subjects) ? response.subjects : [],
        pillars: Array.isArray(response && response.pillars) ? response.pillars : []
      };
    });

    const deliveredTotal = safeTemplates.reduce(function (sum, group) {
      return sum + computeDeliveredRecipients(group, classMembers);
    }, 0);

    const responsesThisWeek = responsesNormalized.filter(function (item) {
      return (item.updatedAtMillis || 0) >= weekStartMillis;
    }).length;

    const templatesThisWeek = safeTemplates.filter(function (group) {
      return toMillis(group && group.createdAtMillis ? group.createdAtMillis : 0) >= weekStartMillis;
    }).length;

    const unreadNotificationsTotal = responsesNormalized.reduce(function (sum, item) {
      return sum + (seenSet.has(item.responseKey) ? 0 : 1);
    }, 0);

    const pillarCandidatesFromResponses = [];
    responsesNormalized.forEach(function (item) {
      (Array.isArray(item.pillars) ? item.pillars : []).forEach(function (pillar) {
        pillarCandidatesFromResponses.push(pillar);
      });
    });
    const pillarCandidatesFromTemplates = [];
    safeTemplates.forEach(function (group) {
      (group && Array.isArray(group.pillars) ? group.pillars : []).forEach(function (pillar) {
        pillarCandidatesFromTemplates.push(pillar);
      });
    });
    const topPillar = pickMostFrequentLabel(
      pillarCandidatesFromResponses.length ? pillarCandidatesFromResponses : pillarCandidatesFromTemplates,
      "—"
    );

    const notifications = responsesNormalized.slice(0, 4).map(function (item) {
      const studentLabel = resolveStudentLabelFromEmail(item.userEmail, studentByEmail);
      const unread = !seenSet.has(item.responseKey);
      return {
        responseKey: item.responseKey,
        templateId: item.templateId,
        templateTitle: item.templateTitle,
        studentLabel: studentLabel,
        dateLabel: formatDateTime(item.updatedAtMillis),
        unread: unread
      };
    });

    return {
      weekStartMillis: weekStartMillis,
      studentsTotal: studentDirectory.length,
      classesTotal: safeClasses.length,
      templatesTotal: safeTemplates.length,
      sendsTotal: safeTemplates.length,
      templatesThisWeek: templatesThisWeek,
      responsesThisWeek: responsesThisWeek,
      responsesTotal: responsesNormalized.length,
      deliveredTotal: deliveredTotal,
      topPillar: topPillar,
      notifications: notifications,
      unreadNotificationsTotal: unreadNotificationsTotal,
      updatedAtMillis: nowMillis
    };
  }

  function updateDashboardPills(stats) {
    const data = stats || {};

    const pillDay = $("#pillDay");
    if (pillDay) {
      pillDay.textContent = String(data.templatesThisWeek || 0);
    }

    const pillTemplates = $("#pillTemplates");
    if (pillTemplates) {
      pillTemplates.textContent = String(data.templatesTotal || 0);
    }

    const pillClasses = $("#pillClasses");
    if (pillClasses) {
      pillClasses.textContent = String(data.classesTotal || 0);
    }

    const pillUnread = $("#pillUnread");
    if (pillUnread) {
      pillUnread.textContent = String(data.unreadNotificationsTotal || 0);
    }
  }

  function renderDashboardMetric(value, label) {
    return (
      '<article class="dashMetric">' +
      '<p class="dashMetricValue">' + esc(value) + '</p>' +
      '<div class="dashMetricLabel">' + esc(label) + '</div>' +
      '</article>'
    );
  }

  function renderDashboardNotifications(notifications) {
    const items = Array.isArray(notifications) ? notifications : [];
    return (
      '<section>' +
      '<div class="dashSectionHead">' +
      '<h4 class="dashSectionTitle">Poslední notifikace</h4>' +
      '<button class="dashGhostBtn" id="dashOpenNotifications" type="button">Otevřít 🔔</button>' +
      '</div>' +
      (items.length
        ? '<div class="dashNotifList">' +
          items.map(function (item) {
            const statusLabel = item.unread ? "Nepřečteno" : "Přečteno";
            const statusClass = item.unread ? "dashState" : "dashState read";
            return (
              '<article class="dashNotifItem">' +
              '<div>' +
              '<p class="dashNotifTitle">Dítě vyplnilo šablonu: „' + esc(item.templateTitle) + '“.</p>' +
              '<div class="dashChips">' +
              '<span class="dashChip">' + esc(item.studentLabel) + '</span>' +
              '<span class="dashChip">' + esc(item.templateTitle) + '</span>' +
              (item.dateLabel ? '<span class="dashChip">' + esc(item.dateLabel) + '</span>' : '') +
              '</div>' +
              '</div>' +
              '<div class="row">' +
              '<span class="' + statusClass + '">' + statusLabel + '</span>' +
              '<button class="dashOpenBtn dashNotifOpen" type="button" data-response-key="' + esc(item.responseKey) + '" data-template-id="' + esc(item.templateId) + '">Otevřít</button>' +
              '</div>' +
              '</article>'
            );
          }).join("") +
          '</div>'
        : '<div class="empty">Zatím žádné notifikace o vyplnění.</div>') +
      '</section>'
    );
  }

  function renderDashboardActions() {
    return (
      '<section>' +
      '<div class="dashSectionHead">' +
      '<h4 class="dashSectionTitle">Rychlé akce</h4>' +
      '</div>' +
      '<div class="dashActionList">' +
      '<article class="dashActionItem">' +
      '<div>' +
      '<p class="dashActionTitle">Vytvořit novou šablonu</p>' +
      '<div class="dashChips"><span class="dashChip" title="Uložit">:floppy_disk:</span><span class="dashChip" title="Uložit a odeslat">:rocket:</span></div>' +
      '</div>' +
      '<button class="dashActionBtn" id="dashActionNew" type="button">➕ Otevřít</button>' +
      '</article>' +
      '<article class="dashActionItem">' +
      '<div>' +
      '<p class="dashActionTitle">Spravovat třídy a skupiny</p>' +
      '<div class="dashChips"><span class="dashChip" title="Třídy a skupiny">:busts_in_silhouette:</span><span class="dashChip" title="Vyhledávání">:mag:</span></div>' +
      '</div>' +
      '<button class="dashActionBtn neutral" id="dashActionClasses" type="button">👥 Třídy</button>' +
      '</article>' +
      '<article class="dashActionItem">' +
      '<div>' +
      '<p class="dashActionTitle">Zkontrolovat šablony podle tříd</p>' +
      '<div class="dashChips"><span class="dashChip" title="Statusy">:traffic_light:</span><span class="dashChip" title="Komentáře">:speech_balloon:</span></div>' +
      '</div>' +
      '<button class="dashActionBtn neutral" id="dashActionTemplates" type="button">🗂️ Moje šablony</button>' +
      '</article>' +
      '</div>' +
      '<div class="dashShortcut">🔎 Zkratky: <span class="dashKey">N</span> Notifikace, <span class="dashKey">T</span> Test simulace, <span class="dashKey">Shift</span> + <span class="dashKey">R</span> Reset dat.</div>' +
      '</section>'
    );
  }

  function renderDashboardContent(stats) {
    const weekLabel = formatDateTime(stats.weekStartMillis);
    return (
      '<section class="dashWrap">' +
      '<div class="dashHead">' +
      '<div><strong class="dashHeadTitle">Rychlé metriky</strong><span class="dashHeadMeta">aktuální data</span></div>' +
      '<span class="dashWeekChip">Týden od: ' + esc(weekLabel) + '</span>' +
      '</div>' +
      '<div class="dashBody">' +
      '<div class="dashMetricGrid">' +
      renderDashboardMetric(String(stats.studentsTotal), "Dětí v databázi") +
      renderDashboardMetric(String(stats.classesTotal), "Tříd / skupin") +
      renderDashboardMetric(String(stats.templatesTotal), "Šablon (celkem)") +
      renderDashboardMetric(String(stats.sendsTotal), "Odeslání (celkem)") +
      renderDashboardMetric(String(stats.templatesThisWeek), "Odesláno tento týden") +
      renderDashboardMetric(String(stats.responsesThisWeek), "Vyplněno tento týden") +
      renderDashboardMetric(String(stats.responsesTotal) + " / " + String(stats.deliveredTotal), "Vyplněno celkem / doručeno") +
      renderDashboardMetric(stats.topPillar === "Neurčeno" ? "—" : formatCategoryEmoji(stats.topPillar), "Nejčastější pilíř") +
      '</div>' +
      '<hr class="composeDivider">' +
      '<div class="dashSplit">' +
      renderDashboardNotifications(stats.notifications) +
      renderDashboardActions() +
      '</div>' +
      '</div>' +
      '</section>'
    );
  }

  function bindDashboardEvents(stats) {
    function updateUnreadPillAfterMark(markedKeys) {
      const pillUnread = $("#pillUnread");
      if (!pillUnread) {
        return;
      }
      const unreadKeys = new Set(
        (Array.isArray(stats && stats.notifications) ? stats.notifications : [])
          .filter(function (item) { return item && item.unread; })
          .map(function (item) { return String(item.responseKey || "").trim(); })
          .filter(Boolean)
      );
      let nextValue = Number(stats && stats.unreadNotificationsTotal ? stats.unreadNotificationsTotal : 0) || 0;
      (Array.isArray(markedKeys) ? markedKeys : []).forEach(function (key) {
        const value = String(key || "").trim();
        if (!value || !unreadKeys.has(value)) {
          return;
        }
        unreadKeys.delete(value);
        nextValue -= 1;
      });
      pillUnread.textContent = String(Math.max(0, nextValue));
    }

    const goNotifications = $("#dashOpenNotifications");
    if (goNotifications) {
      goNotifications.addEventListener("click", function () {
        const responseKeys = Array.isArray(stats && stats.notifications)
          ? stats.notifications.map(function (item) { return item.responseKey; }).filter(Boolean)
          : [];
        markDashboardNotificationsSeen(responseKeys);
        updateUnreadPillAfterMark(responseKeys);
        setView("notifications");
      });
    }

    const notifButtons = document.querySelectorAll(".dashNotifOpen");
    for (let i = 0; i < notifButtons.length; i += 1) {
      const button = notifButtons[i];
      button.addEventListener("click", function () {
        const responseKey = String(button.dataset && button.dataset.responseKey ? button.dataset.responseKey : "").trim();
        if (responseKey) {
          markDashboardNotificationsSeen([responseKey]);
          updateUnreadPillAfterMark([responseKey]);
        }
        setView("myTemplates");
      });
    }

    const actionNew = $("#dashActionNew");
    if (actionNew) {
      actionNew.addEventListener("click", function () {
        setView("newTemplate");
      });
    }

    const actionClasses = $("#dashActionClasses");
    if (actionClasses) {
      actionClasses.addEventListener("click", function () {
        setView("classes");
      });
    }

    const actionTemplates = $("#dashActionTemplates");
    if (actionTemplates) {
      actionTemplates.addEventListener("click", function () {
        setView("myTemplates");
      });
    }
  }

  async function renderDashboardView() {
    const content = $("#content");
    if (!content) {
      return;
    }

    content.innerHTML =
      '<div class="card">' +
      '<h3>Dashboard</h3>' +
      '<div class="cardBody">Načítám přehled…</div>' +
      '</div>';

    await Promise.all([loadRecipientDirectory(), loadSubjectDirectory()]);

    let templateGroups = [];
    try {
      templateGroups = await loadMyTemplateGroups();
    } catch (error) {
      console.error("Dashboard templates load failed:", error);
      toast("Nepodařilo se načíst šablony do dashboardu.");
    }

    let responses = [];
    try {
      const templateIds = collectTemplateIdsFromGroups(templateGroups);
      responses = await loadDashboardResponses(templateIds);
    } catch (error) {
      console.error("Dashboard responses load failed:", error);
      responses = [];
    }

    const classGroups = buildClassGroups(recipientDirectory.students);
    const seenSet = loadDashboardNotificationSeenSet();
    const stats = computeDashboardStats(templateGroups, classGroups, responses, seenSet);
    updateDashboardPills(stats);

    if (currentView !== "dashboard") {
      return;
    }

    content.innerHTML = renderDashboardContent(stats);
    bindDashboardEvents(stats);
  }

  function buildNotificationEntries(templateGroups, responses, seenSet) {
    const groups = Array.isArray(templateGroups) ? templateGroups : [];
    const sourceResponses = Array.isArray(responses) ? responses : [];
    const seen = seenSet instanceof Set ? seenSet : new Set();

    const templateTitleById = new Map();
    groups.forEach(function (group) {
      const title = String(group && group.title ? group.title : "").trim();
      (group && Array.isArray(group.templateIds) ? group.templateIds : []).forEach(function (templateId) {
        const id = String(templateId || "").trim();
        if (id && title) {
          templateTitleById.set(id, title);
        }
      });
    });

    const studentByEmail = new Map();
    (Array.isArray(recipientDirectory.students) ? recipientDirectory.students : []).forEach(function (student) {
      const email = normalizeEmail(student && student.email ? student.email : "");
      if (email) {
        studentByEmail.set(email, student);
      }
    });

    const entries = sourceResponses.map(function (response) {
      const templateId = String(response && response.templateId ? response.templateId : "").trim();
      const fallbackTitle = templateId ? templateTitleById.get(templateId) : "";
      const templateTitle = String(response && response.templateTitle ? response.templateTitle : "").trim() || fallbackTitle || "Bez názvu";
      const userEmail = normalizeEmail(response && response.userEmail ? response.userEmail : "");
      const updatedAtMillis = toMillis(response && response.updatedAtMillis ? response.updatedAtMillis : 0);
      const responseKey = String(response && response.responseKey ? response.responseKey : "").trim()
        || [userEmail || "user", templateId || "template", String(updatedAtMillis || 0)].join("|");
      const studentLabel = resolveStudentLabelFromEmail(userEmail, studentByEmail);
      const dateLabel = formatDateTime(updatedAtMillis);
      const unread = !seen.has(responseKey);
      const searchText = normalizeSearchText(studentLabel + " " + templateTitle + " " + dateLabel);
      return {
        responseKey: responseKey,
        templateId: templateId,
        templateTitle: templateTitle,
        studentLabel: studentLabel,
        dateLabel: dateLabel,
        unread: unread,
        updatedAtMillis: updatedAtMillis,
        searchText: searchText
      };
    });

    entries.sort(function (a, b) {
      return (b.updatedAtMillis || 0) - (a.updatedAtMillis || 0);
    });
    return entries;
  }

  function renderNotificationsIntro(entries) {
    const items = Array.isArray(entries) ? entries : [];
    const unreadCount = items.reduce(function (sum, item) {
      return sum + (item && item.unread ? 1 : 0);
    }, 0);
    return (
      '<section class="notifIntro">' +
      '<div>' +
      '<h3 class="notifIntroTitle">Notifikace</h3>' +
      '<p class="notifIntroSub">Zde vidíš, kdo co vyplnil. Kliknutím otevřeš detail.</p>' +
      '</div>' +
      '<div class="notifIntroActions">' +
      '<span class="notifShortcut">🔔 Zobrazit <span class="dashKey">N</span></span>' +
      '<span class="badge unread">Nepřečteno: ' + String(unreadCount) + '</span>' +
      '<button class="btn primary" id="notifGoNew" type="button">➕ Nová šablona</button>' +
      '</div>' +
      '</section>'
    );
  }

  function renderNotificationsPanel(entries) {
    const items = Array.isArray(entries) ? entries : [];
    return (
      '<section class="notifPanel">' +
      '<div class="notifPanelHead">' +
      '<div><strong class="notifPanelTitle">Notifikace</strong><span class="notifPanelHint">klikni pro detail</span></div>' +
      '<div class="notifPanelControls">' +
      '<input id="notifSearch" class="notifSearch" type="text" placeholder="Hledat...">' +
      '<button class="dashGhostBtn" id="notifMarkAllRead" type="button">Označit vše jako přečtené</button>' +
      '</div>' +
      '</div>' +
      (items.length
        ? '<div class="notifList" id="notifList">' +
          items.map(function (item) {
            const stateLabel = item.unread ? "Nepřečteno" : "Přečteno";
            const stateClass = item.unread ? "dashState" : "dashState read";
            return (
              '<article class="notifItem" data-search="' + esc(item.searchText) + '">' +
              '<div>' +
              '<p class="notifItemTitle">Dítě vyplnilo šablonu: „' + esc(item.templateTitle) + '“.</p>' +
              '<div class="dashChips">' +
              '<span class="dashChip">' + esc(item.studentLabel) + '</span>' +
              '<span class="dashChip">' + esc(item.templateTitle) + '</span>' +
              (item.dateLabel ? '<span class="dashChip">' + esc(item.dateLabel) + '</span>' : '') +
              '</div>' +
              '</div>' +
              '<div class="row">' +
              '<span class="' + stateClass + '">' + stateLabel + '</span>' +
              '<button class="dashOpenBtn notifOpen" type="button" data-response-key="' + esc(item.responseKey) + '" data-template-id="' + esc(item.templateId) + '">Otevřít</button>' +
              '</div>' +
              '</article>'
            );
          }).join("") +
          '</div>' +
          '<div class="empty notifEmpty hidden" id="notifFilterEmpty">Žádná notifikace neodpovídá filtru.</div>'
        : '<div class="empty notifEmpty">Zatím žádné notifikace o vyplnění.</div>') +
      '</section>'
    );
  }

  function renderNotificationsContent(entries) {
    return (
      '<div class="notifStack">' +
      renderNotificationsIntro(entries) +
      renderNotificationsPanel(entries) +
      '</div>'
    );
  }

  function filterNotificationsList(filterValue) {
    const list = $("#notifList");
    if (!list) {
      return;
    }
    const query = normalizeSearchText(filterValue);
    const items = list.querySelectorAll(".notifItem");
    let visibleCount = 0;
    for (let i = 0; i < items.length; i += 1) {
      const item = items[i];
      const searchText = String(item.dataset && item.dataset.search ? item.dataset.search : "");
      const visible = !query || searchText.indexOf(query) >= 0;
      item.style.display = visible ? "" : "none";
      if (visible) {
        visibleCount += 1;
      }
    }
    const empty = $("#notifFilterEmpty");
    if (empty) {
      empty.classList.toggle("hidden", visibleCount > 0);
    }
  }

  function bindNotificationsEvents(entries) {
    const goNew = $("#notifGoNew");
    if (goNew) {
      goNew.addEventListener("click", function () {
        setView("newTemplate");
      });
    }

    const markAllRead = $("#notifMarkAllRead");
    if (markAllRead) {
      markAllRead.addEventListener("click", function () {
        const unreadKeys = (Array.isArray(entries) ? entries : []).filter(function (item) {
          return item && item.unread;
        }).map(function (item) {
          return String(item.responseKey || "").trim();
        }).filter(Boolean);

        if (!unreadKeys.length) {
          toast("Všechny notifikace jsou už přečtené.");
          return;
        }
        markDashboardNotificationsSeen(unreadKeys);
        setView("notifications");
      });
    }

    const searchInput = $("#notifSearch");
    if (searchInput) {
      searchInput.addEventListener("input", function () {
        filterNotificationsList(searchInput.value);
      });
      filterNotificationsList(searchInput.value);
    }

    const openButtons = document.querySelectorAll(".notifOpen");
    for (let i = 0; i < openButtons.length; i += 1) {
      const button = openButtons[i];
      button.addEventListener("click", function () {
        const responseKey = String(button.dataset && button.dataset.responseKey ? button.dataset.responseKey : "").trim();
        if (responseKey) {
          markDashboardNotificationsSeen([responseKey]);
        }
        setView("myTemplates");
      });
    }
  }

  async function renderNotificationsView() {
    const content = $("#content");
    if (!content) {
      return;
    }

    content.innerHTML =
      '<div class="card">' +
      '<h3>Notifikace</h3>' +
      '<div class="cardBody">Načítám notifikace…</div>' +
      '</div>';

    await Promise.all([loadRecipientDirectory(), loadSubjectDirectory()]);

    let templateGroups = [];
    try {
      templateGroups = await loadMyTemplateGroups();
    } catch (error) {
      console.error("Notifications templates load failed:", error);
      toast("Nepodařilo se načíst šablony pro notifikace.");
    }

    let responses = [];
    try {
      const templateIds = collectTemplateIdsFromGroups(templateGroups);
      responses = await loadDashboardResponses(templateIds);
    } catch (error) {
      console.error("Notifications responses load failed:", error);
      responses = [];
    }

    const classGroups = buildClassGroups(recipientDirectory.students);
    const seenSet = loadDashboardNotificationSeenSet();
    const stats = computeDashboardStats(templateGroups, classGroups, responses, seenSet);
    const entries = buildNotificationEntries(templateGroups, responses, seenSet);
    updateDashboardPills(stats);

    if (currentView !== "notifications") {
      return;
    }

    content.innerHTML = renderNotificationsContent(entries);
    bindNotificationsEvents(entries);
  }

  function formatDateTime(value) {
    if (!value && value !== 0) {
      return "";
    }
    const date = new Date(value);
    if (Number.isNaN(date.getTime())) {
      return "";
    }
    const day = String(date.getDate()).padStart(2, "0");
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, "0");
    const minutes = String(date.getMinutes()).padStart(2, "0");
    return day + "." + month + "." + year + " " + hours + ":" + minutes;
  }

  function collectTemplateValues(data, key, fallbackKey) {
    if (!data || typeof data !== "object") {
      return [];
    }
    if (Array.isArray(data[key]) && data[key].length) {
      return uniqueValues(data[key].map(function (item) {
        return String(item || "").trim();
      }));
    }
    if (fallbackKey && data[fallbackKey]) {
      return uniqueValues([String(data[fallbackKey]).trim()]);
    }
    return [];
  }

  async function loadMyTemplateGroups() {
    if (!currentUser || !templatesRef) {
      return [];
    }

    const snapshot = await templatesRef.where("createdBy", "==", currentUser.uid).get();
    const grouped = new Map();

    snapshot.forEach(function (doc) {
      const data = doc.data() || {};
      const title = String(data.title || "Bez názvu").trim();
      const createdAtMillis = data.createdAt && typeof data.createdAt.toMillis === "function"
        ? data.createdAt.toMillis()
        : 0;
      const createdAtClient = Number(data.createdAtClient) || 0;
      const batchId = String(data.sentBatchId || "").trim();
      const fallbackKey = createdAtClient
        ? "client|" + createdAtClient
        : (createdAtMillis ? "legacy|" + createdAtMillis + "|" + title.toLowerCase() : "doc|" + doc.id);
      const key = batchId ? "batch|" + batchId : fallbackKey;

      if (!grouped.has(key)) {
        grouped.set(key, {
          title: title || "Bez názvu",
          annotation: String(data.annotation || "").trim(),
          output: String(data.output || "").trim(),
          createdAtMillis: createdAtMillis || createdAtClient || 0,
          subjects: new Set(),
          pillars: new Set(),
          recipients: new Set(),
          templateIds: new Set(),
          recipientTargets: []
        });
      }

      const group = grouped.get(key);
      group.templateIds.add(doc.id);
      if (createdAtMillis > group.createdAtMillis) {
        group.createdAtMillis = createdAtMillis;
      }
      if (!group.annotation && data.annotation) {
        group.annotation = String(data.annotation).trim();
      }
      if (!group.output && data.output) {
        group.output = String(data.output).trim();
      }

      collectTemplateValues(data, "subjects", "subject").forEach(function (subject) {
        if (subject) {
          group.subjects.add(subject);
        }
      });
      collectTemplateValues(data, "pillars", "pillar").forEach(function (pillar) {
        if (pillar) {
          group.pillars.add(pillar);
        }
      });

      const recipientType = String(data.recipientType || "").trim();
      const recipientValue = String(data.recipientValue || "").trim();
      if (recipientType || recipientValue) {
        group.recipients.add((recipientType || "recipient") + "|" + recipientValue);
        group.recipientTargets.push({
          type: recipientType || "recipient",
          value: recipientValue
        });
      }
    });

    return Array.from(grouped.values())
      .map(function (group) {
        return {
          title: group.title,
          annotation: group.annotation,
          output: group.output,
          createdAtMillis: group.createdAtMillis,
          subjects: Array.from(group.subjects.values()),
          pillars: Array.from(group.pillars.values()),
          recipientCount: group.recipients.size,
          templateIds: Array.from(group.templateIds.values()),
          recipientTargets: group.recipientTargets.slice()
        };
      })
      .sort(function (a, b) {
        return b.createdAtMillis - a.createdAtMillis;
      });
  }

  function renderMyTemplatesList(groups) {
    if (!Array.isArray(groups) || !groups.length) {
      return (
        '<div class="card">' +
        '<h3>Moje šablony</h3>' +
        '<div class="cardBody empty">Zatím tu nejsou žádné odeslané šablony.</div>' +
        '</div>'
      );
    }

    return (
      '<div class="card">' +
      '<h3>Moje šablony</h3>' +
      '<div class="cardBody list">' +
      groups.map(function (group) {
        const dateLabel = formatDateTime(group.createdAtMillis);
        const subjectBadges = (group.subjects || []).slice(0, 3).map(function (subject) {
          return '<span class="badge" title="' + esc(subject) + '">' + esc(formatCategoryEmoji(subject)) + '</span>';
        }).join("");
        const pillarBadges = (group.pillars || []).slice(0, 3).map(function (pillar) {
          return '<span class="badge" title="' + esc(pillar) + '">' + esc(formatCategoryEmoji(pillar)) + '</span>';
        }).join("");
        const recipientBadge = '<span class="badge ok">Příjemci: ' + String(group.recipientCount || 0) + '</span>';
        const dateBadge = dateLabel ? '<span class="badge">' + esc(dateLabel) + '</span>' : '';
        const annotation = group.annotation ? '<div class="hint">' + esc(group.annotation) + '</div>' : '';

        return (
          '<div class="item">' +
          '<div>' +
          '<div class="title">' + esc(group.title || "Bez názvu") + '</div>' +
          annotation +
          '<div class="meta">' + subjectBadges + pillarBadges + recipientBadge + dateBadge + '</div>' +
          '</div>' +
          '<span class="badge unread">Odesláno</span>' +
          '</div>'
        );
      }).join("") +
      '</div>' +
      '</div>'
    );
  }

  async function renderMyTemplatesView() {
    const content = $("#content");
    if (!content) {
      return;
    }

    content.innerHTML =
      '<div class="card">' +
      '<h3>Moje šablony</h3>' +
      '<div class="cardBody">Načítám odeslané šablony…</div>' +
      '</div>';

    let groups = [];
    try {
      groups = await loadMyTemplateGroups();
    } catch (error) {
      console.error("My templates load failed:", error);
      if (currentView === "myTemplates") {
        content.innerHTML =
          '<div class="card">' +
          '<h3>Moje šablony</h3>' +
          '<div class="cardBody empty">Nepodařilo se načíst odeslané šablony.</div>' +
          '</div>';
      }
      return;
    }

    const pillTemplates = $("#pillTemplates");
    if (pillTemplates) {
      pillTemplates.textContent = String(groups.length);
    }

    if (currentView !== "myTemplates") {
      return;
    }

    content.innerHTML = renderMyTemplatesList(groups);
  }

  async function handleTemplateSave(sendNow) {
    const data = getFormData();
    const validationError = validateForm(data, sendNow);
    if (validationError) {
      toast(validationError);
      return;
    }

    const recipients = buildRecipientTargets(data);

    if (!sendNow) {
      toast(
        "Šablona připravena.",
        data.subjects.length + " předmětů, " + data.pillars.length + " pilířů, " + recipients.length + " příjemců."
      );
      return;
    }

    if (!currentUser || !templatesRef || !db) {
      toast("Není připraveno odeslání. Obnov stránku.");
      return;
    }

    const instructions = "Anotace:\n" + data.annotation + "\n\nOčekávaný výstup:\n" + data.output;

    try {
      const sentBatchId = "batch-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2, 8);
      const createdAtClient = Date.now();
      const basePayload = {
        title: data.title,
        subject: data.subject,
        subjects: data.subjects,
        instructions: instructions,
        proofType: "text",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAtClient: createdAtClient,
        createdBy: currentUser.uid,
        createdByEmail: currentUser.email || "",
        annotation: data.annotation,
        output: data.output,
        pillar: data.pillar,
        pillars: data.pillars,
        sentBatchId: sentBatchId
      };

      const chunkSize = 400;
      for (let offset = 0; offset < recipients.length; offset += chunkSize) {
        const batch = db.batch();
        const chunk = recipients.slice(offset, offset + chunkSize);
        chunk.forEach(function (recipient) {
          const recipientValueLower = String(recipient.recipientValue || "").toLowerCase();
          const docRef = templatesRef.doc();
          batch.set(docRef, Object.assign({}, basePayload, {
            recipientType: recipient.recipientType,
            recipientValue: recipient.recipientValue,
            recipientValueLower: recipientValueLower
          }));
        });
        await batch.commit();
      }

      toast("Šablona odeslána.", recipients.length + " příjemců");
      clearForm();
      const pillTemplates = $("#pillTemplates");
      if (pillTemplates) {
        const currentCount = Number(pillTemplates.textContent || "0") || 0;
        pillTemplates.textContent = String(currentCount + 1);
      }
      const pillDay = $("#pillDay");
      if (pillDay) {
        const currentDayCount = Number(pillDay.textContent || "0") || 0;
        pillDay.textContent = String(currentDayCount + 1);
      }
    } catch (error) {
      console.error("Template send failed:", error);
      toast("Odeslání selhalo. Zkus to znovu.");
    }
  }

  async function loadRecipientDirectory() {
    recipientDirectory = { students: [], classes: [] };
    if (!usersRef) {
      return;
    }

    const classSet = new Set();
    const studentMap = new Map();

    try {
      const snapshot = await usersRef.get();
      snapshot.forEach(function (doc) {
        const data = doc.data() || {};
        const email = normalizeEmail(data.email);
        const className = normalizeClassName(data.className);

        if (className) {
          classSet.add(className);
        }

        if (!email) {
          return;
        }

        studentMap.set(email, {
          uid: doc.id,
          email: email,
          name: String(data.displayName || data.name || email.split("@")[0] || "").trim(),
          className: className
        });
      });

      recipientDirectory.students = Array.from(studentMap.values()).sort(function (a, b) {
        return a.email.localeCompare(b.email, "cs");
      });
      recipientDirectory.classes = Array.from(classSet.values()).sort(function (a, b) {
        return a.localeCompare(b, "cs");
      });
    } catch (error) {
      console.error("Recipient directory load failed:", error);
      toast("Nepodařilo se načíst příjemce.");
    }
  }

  async function loadSubjectDirectory() {
    subjectDirectory = [];
    if (!subjectsRef) {
      return;
    }

    try {
      const snapshot = await subjectsRef.orderBy("nameLower").get();
      const values = [];
      snapshot.forEach(function (doc) {
        const data = doc.data() || {};
        const name = normalizeSubjectName(data.name || data.value || "");
        if (name) {
          values.push(name);
        }
      });
      subjectDirectory = uniqueValues(values);
    } catch (error) {
      console.error("Subject directory load failed:", error);
      toast("Nepodařilo se načíst předměty.");
    }
  }

  function render() {
    const content = $("#content");
    if (!content) {
      return;
    }

    if (currentView === "dashboard") {
      setHeader("Dashboard", "Rychlý přehled šablon, tříd a příjemců.");
      renderDashboardView();
      return;
    }

    if (currentView === "newTemplate") {
      setHeader("Nová šablona", "Vytvoř a odešli šablonu žákům nebo třídě.");
      content.innerHTML = renderNewTemplate();
      bindTemplateEvents();
      return;
    }

    if (currentView === "classes") {
      setHeader("Třídy", "Přehled tříd, počtu žáků a jejich jmen.");
      renderClassesView();
      return;
    }

    if (currentView === "studentOverview") {
      setHeader("Přehled dítěte", "Přístup do portfolií žáků.");
      renderStudentOverviewView();
      return;
    }

    if (currentView === "myTemplates") {
      setHeader("Moje šablony", "Historie odeslaných šablon.");
      renderMyTemplatesView();
      return;
    }

    if (currentView === "notifications") {
      setHeader("Notifikace", "Zde vidíš, kdo co vyplnil. Kliknutím otevřeš detail.");
      renderNotificationsView();
      return;
    }

    renderPlaceholder(currentView);
  }

  function setView(view) {
    currentView = view;
    setNavActive(view);
    syncSidebarVisibility(view);
    render();
  }

  async function denyGuideAccess() {
    alert("Přístup má pouze průvodce.");
    try {
      if (window.firebase && firebase.auth) {
        await firebase.auth().signOut();
      }
    } catch (error) {
      console.warn("Sign-out failed while denying access", error);
    }
    window.location.replace(loginUrl);
  }

  function wireStaticEvents() {
    const btnHome = $("#btnHome");
    if (btnHome) {
      btnHome.addEventListener("click", function () {
        window.location.href = homeUrl;
      });
    }

    const btnTheme = $("#btnTheme");
    if (btnTheme) {
      btnTheme.addEventListener("click", function () {
        const current = document.body.getAttribute("data-theme") === "dark" ? "dark" : "light";
        applyTheme(current === "dark" ? "light" : "dark");
      });
    }

    const nav = $("#nav");
    if (nav) {
      nav.addEventListener("click", function (event) {
        const button = event.target && event.target.closest ? event.target.closest("button[data-view]") : null;
        if (!button || !button.dataset) {
          return;
        }
        setView(button.dataset.view);
      });
    }

    const btnGoNew = $("#btnGoNew");
    if (btnGoNew) {
      btnGoNew.addEventListener("click", function () {
        setView("newTemplate");
      });
    }

    const btnGoNotifs = $("#btnGoNotifs");
    if (btnGoNotifs) {
      btnGoNotifs.addEventListener("click", function () {
        setView("notifications");
      });
    }

    const btnSimulate = $("#btnSimulate");
    if (btnSimulate) {
      btnSimulate.classList.add("hidden");
    }

    const btnReset = $("#btnReset");
    if (btnReset) {
      btnReset.classList.add("hidden");
    }

    if (!document.body.dataset.shortcutBound) {
      document.body.dataset.shortcutBound = "1";
      document.addEventListener("keydown", function (event) {
        if (!event) {
          return;
        }
        const tag = event.target && event.target.tagName ? event.target.tagName.toLowerCase() : "";
        const isInputLike = tag === "input" || tag === "textarea" || tag === "select" || (event.target && event.target.isContentEditable);
        if (isInputLike) {
          return;
        }

        const key = String(event.key || "");
        const normalizedKey = key.toLowerCase();

        if (!event.ctrlKey && !event.metaKey && !event.altKey && !event.shiftKey && normalizedKey === "n") {
          event.preventDefault();
          setView("notifications");
          return;
        }

        if (!event.ctrlKey && !event.metaKey && !event.altKey && !event.shiftKey && normalizedKey === "t") {
          event.preventDefault();
          const simulate = $("#btnSimulate");
          if (simulate && !simulate.classList.contains("hidden")) {
            simulate.click();
          } else {
            toast("TEST simulace je vypnutá.");
          }
          return;
        }

        if (!event.ctrlKey && !event.metaKey && !event.altKey && event.shiftKey && normalizedKey === "r") {
          event.preventDefault();
          const reset = $("#btnReset");
          if (reset && !reset.classList.contains("hidden")) {
            reset.click();
          } else {
            toast("Reset dat je vypnutý.");
          }
        }
      });
    }
  }

  async function init() {
    showContentMessage("Admin přístup", "Ověřuji přístup...");
    applyTheme(getInitialTheme());
    wireStaticEvents();

    if (!window.firebase || !firebase.auth || !firebase.firestore) {
      showContentMessage("Admin přístup", "Firebase knihovny nejsou dostupné.");
      return;
    }

    try {
      if (!firebase.apps || !firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      db = firebase.firestore();
      templatesRef = db.collection("templates");
      usersRef = db.collection("users");
      subjectsRef = db.collection("subjects");
    } catch (error) {
      console.error("Firebase init failed:", error);
      showContentMessage("Admin přístup", "Nepodařilo se inicializovat Firebase.");
      return;
    }

    firebase.auth().onAuthStateChanged(async function (user) {
      if (!user) {
        window.location.replace(loginUrl);
        return;
      }

      if (!hasGuideAccess(user.email)) {
        await denyGuideAccess();
        return;
      }

      currentUser = user;
      await Promise.all([loadRecipientDirectory(), loadSubjectDirectory()]);
      const initialClassGroups = buildClassGroups(recipientDirectory.students);
      let initialTemplateGroups = [];
      try {
        initialTemplateGroups = await loadMyTemplateGroups();
      } catch (error) {
        console.warn("Unable to preload my templates count", error);
      }
      let initialResponses = [];
      try {
        const initialTemplateIds = collectTemplateIdsFromGroups(initialTemplateGroups);
        initialResponses = await loadDashboardResponses(initialTemplateIds);
      } catch (error) {
        console.warn("Unable to preload notifications count", error);
      }
      const initialSeenSet = loadDashboardNotificationSeenSet();
      const initialStats = computeDashboardStats(initialTemplateGroups, initialClassGroups, initialResponses, initialSeenSet);
      updateDashboardPills(initialStats);
      setView("dashboard");
    });
  }

  init();
</script>
</body>
</html>


