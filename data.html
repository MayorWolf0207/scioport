<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Data</title>
</head>
<body>
    <button id="admin">Toggle Admin mode</button>
  <h1 id="user-email"></h1>
  <span id="user-data"></span>

  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBYQPQwKYJLxcdjHHMv8w1KbLIIX-HKaQA",
      authDomain: "scioport.firebaseapp.com",
      projectId: "scioport",
      storageBucket: "scioport.appspot.com",
      messagingSenderId: "612919891675",
      appId: "1:612919891675:web:3adef562f38e26c80e5efe",
      measurementId: "G-7BW8NQ1VKC"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let adminMode = false;

    document.getElementById('admin').onclick = async function() {
      adminMode = !adminMode;
      await renderData();
    };

    async function renderData() {
      const user = firebase.auth().currentUser;
      let dataHtml = '';
      if (adminMode) {
        // Show all users' data
        const usersSnapshot = await db.collection('users').get();
        const promises = [];
        usersSnapshot.forEach(userDoc => {
          const userEmail = userDoc.data().email || userDoc.id;
          promises.push(
            db.collection('users').doc(userDoc.id).collection('data').orderBy('timestamp', 'desc').get()
              .then(dataSnapshot => {
                let userData = `<h1>${userEmail}</h1>`;
                dataSnapshot.forEach(doc => {
                  userData += `<span>${doc.data().value}</span><br>`;
                });
                userData += `<hr>`;
                return userData;
              })
          );
        });
        const allUsersData = await Promise.all(promises);
        dataHtml = allUsersData.join('');
        document.getElementById('user-data').innerHTML = dataHtml;
        document.getElementById('user-email').textContent = adminMode ? "Admin Mode: All Users" : user.email;
      } else {
        // Show only current user's data
        document.getElementById('user-email').textContent = user.email;
        const dataRef = db.collection('users').doc(user.uid).collection('data');
        const snapshot = await dataRef.orderBy('timestamp', 'desc').get();
        snapshot.forEach(doc => {
          dataHtml += `<div>${doc.data().value}</div>`;
        });
        document.getElementById('user-data').innerHTML = dataHtml;
      }
    }

    firebase.auth().onAuthStateChanged(async function(user) {
      if (user) {
        await renderData();
      } else {
        window.location.href = "login";
      }
    });
  </script>
</body>
</html>